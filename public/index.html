<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DUEL LIVE</title>

  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg-dark:#0f0f12;
      --panel:#14141b;
      --panel2:#0b0b10;
      --p1:#ff4757;
      --p2:#2e86de;
      --accent:#feca57;
      --text:#ffffff;
      --grid:rgba(255,255,255,0.05);
      --sidebar:340px;
      --betH:255px;
      --playersH:255px;
    }
    *{box-sizing:border-box; font-family:'Press Start 2P', monospace;}
    html,body{height:100%;margin:0;overflow:hidden;background:var(--bg-dark);color:var(--text);}
    body{
      background-image:
        linear-gradient(var(--grid) 1px, transparent 1px),
        linear-gradient(90deg, var(--grid) 1px, transparent 1px);
      background-size:20px 20px;
      display:flex;
    }

    .custom-scroll{overflow:auto; scrollbar-width:thin}
    .custom-scroll::-webkit-scrollbar{width:6px;height:6px}
    .custom-scroll::-webkit-scrollbar-thumb{background:#444}
    .custom-scroll::-webkit-scrollbar-track{background:transparent}

    .main{display:flex;width:100%;height:100%;padding:16px;gap:16px;min-height:0}
    .game{flex:1;min-width:0;display:flex;flex-direction:column;min-height:0}
    .side{width:var(--sidebar);min-width:var(--sidebar);display:flex;flex-direction:column;gap:12px;min-height:0}

    .topbar{display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;align-items:flex-start;padding-bottom:12px;border-bottom:3px solid #222}
    h1{margin:0;color:var(--accent);font-size:18px;text-shadow:3px 3px 0 #000}

    .btn{
      border:2px solid #000;background:#2f3640;color:#fff;
      padding:10px 12px;font-size:10px;cursor:pointer;box-shadow:3px 3px 0 #000
    }
    .btn:disabled{opacity:.35;cursor:not-allowed;filter:grayscale(1)}
    .btn.yellow{background:var(--accent);color:#000}
    .btn.green{background:#2ecc71;color:#000}
    .btn.gray{background:#555}
    .btn:active{transform:translate(2px,2px);box-shadow:1px 1px 0 #000}

    .pill{
      border:2px solid #333;background:#000;padding:10px 12px;font-size:10px;
      display:flex;gap:14px;align-items:center;flex-wrap:wrap
    }
    .pill b{color:var(--accent)}
    .pill .ok{color:#2ecc71}

    .tabs{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin:14px 0 12px 0;padding:10px;background:#000;border:2px solid #222;border-radius:8px}
    .tab{background:#222;color:#aaa;border:2px solid #333;padding:10px 14px;font-size:10px;cursor:pointer}
    .tab.active{background:var(--accent);color:#000;border-color:#fff;box-shadow:0 0 10px rgba(254,202,87,.25)}
    .tab.locked{opacity:.35;pointer-events:none}

    .arena{flex:1;min-height:0;display:grid;grid-template-columns:1fr 1.2fr 1fr;gap:14px}
    .panel{
      border:3px solid #000;background:var(--panel);box-shadow:4px 4px 0 #000;min-height:0;overflow:hidden
    }
    .phead{
      display:flex;gap:10px;align-items:center;justify-content:center;
      padding:10px;border-bottom:3px solid #000;background:#222;font-size:11px
    }
    .avatarWrap{position:relative;display:flex;align-items:center;gap:10px}
    .avatar{
      width:28px;height:28px;border:2px solid #000;box-shadow:2px 2px 0 #000;
      background:#111;image-rendering:pixelated;
    }
    .a1{background:#6c5ce7}.a2{background:#00b894}.a3{background:#e17055}.a4{background:#0984e3}.a5{background:#d63031}.a6{background:#2d3436}

    .bubble{
      position:absolute;left:34px;top:-10px;
      background:#000;border:2px solid #333;padding:6px 8px;font-size:10px;color:#fff;
      box-shadow:2px 2px 0 #000;opacity:0;transform:translateY(4px);
      transition:opacity .15s, transform .15s;pointer-events:none;
      white-space:nowrap;
    }
    .bubble.show{opacity:1;transform:translateY(0)}
    .bubble:after{
      content:"";position:absolute;left:8px;bottom:-8px;
      border:8px solid transparent;border-top-color:#000;
      filter:drop-shadow(2px 2px 0 #000);
    }

    .scoreArea{display:flex;flex-direction:column;align-items:center;justify-content:center;height:220px}
    .score{font-size:56px}
    .turnTag{
      margin-top:10px;border:2px solid #333;background:#000;padding:8px 10px;
      font-size:10px;color:#aaa;display:none
    }
    .turnTag.show{display:inline-block}
    .active1{border-color:var(--p1);box-shadow:0 0 16px rgba(255,71,87,.35)}
    .active2{border-color:var(--p2);box-shadow:0 0 16px rgba(46,134,222,.35)}

    .pcontrols{padding:12px;display:flex;flex-direction:column;gap:10px;background:var(--panel2);border-top:3px solid #000}
    .group{border:2px solid #222;background:#000;padding:10px;display:flex;flex-direction:column;gap:8px}
    .gt{font-size:9px;color:#888}
    select,input{
      width:100%;background:#000;border:2px solid #333;color:#fff;padding:12px;font-size:10px
    }
    input{height:46px}
    .seatBtn{border:2px dashed #666;background:#222;color:#aaa;padding:14px;font-size:10px;cursor:pointer}
    .seatBtn:hover{border-color:#fff;color:#fff}

    .center{display:flex;flex-direction:column;height:100%}
    .hdrLine{border-bottom:2px solid #222;background:#111;padding:10px;text-align:center;font-size:12px}
    .statusLine{border-bottom:2px solid #222;background:#0d0d12;padding:10px;text-align:center;font-size:10px;color:#bbb;min-height:36px;display:flex;align-items:center;justify-content:center}
    .potLine{border-bottom:2px solid #222;background:#0b0b10;padding:10px;text-align:center;font-size:10px;color:var(--accent);display:none;min-height:36px;align-items:center;justify-content:center}
    .proposalLine{border-bottom:2px solid #222;background:#000;padding:10px;text-align:center;font-size:9px;color:#aaa;display:none}
    .gameBox{flex:1;min-height:0;display:grid;place-items:center;background:#000;position:relative;overflow:hidden}
    .pixelCard{border:3px solid #222;background:#0b0b10;box-shadow:6px 6px 0 #000;padding:18px;text-align:center}
    .bigNum{font-size:40px;color:#fff}
    .animShake{animation:shake .28s ease-in-out}
    @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-6px)}50%{transform:translateX(6px)}75%{transform:translateX(-4px)}}
    .animFlip{animation:flip .6s ease-in-out}
    @keyframes flip{0%{transform:rotateY(0)}50%{transform:rotateY(180deg)}100%{transform:rotateY(360deg)}}

    .sidePanel{border:3px solid #000;background:var(--panel);box-shadow:4px 4px 0 #000;overflow:hidden;min-height:0}
    .sideHead{background:#222;border-bottom:3px solid #000;padding:10px 12px;font-size:10px;text-transform:uppercase;display:flex;justify-content:space-between;align-items:center}
    .betWrap{height:var(--betH);display:flex;flex-direction:column}
    .betBody{padding:12px;background:#0b0b10;border-bottom:3px solid #000}
    .betOverlay{
      position:absolute;inset:0;background:rgba(0,0,0,.85);
      display:flex;align-items:center;justify-content:center;text-align:center;padding:18px;font-size:10px;color:#aaa
    }
    .betBox{position:relative;flex:1}
    .betBtn{width:100%;margin-top:8px}
    .playersWrap{height:var(--playersH);display:flex;flex-direction:column;min-height:0}
    .plist{flex:1;min-height:0;background:#222}
    .pitem{
      display:flex;align-items:center;justify-content:space-between;
      padding:10px 12px;border-bottom:1px solid #111;cursor:pointer
    }
    .pitem:hover{background:#2b2b38}
    .ptag{border:1px solid #444;border-radius:999px;padding:2px 8px;font-size:10px;color:#aaa}
    .mic{opacity:.2}
    .mic.on{opacity:1;color:#2ecc71;text-shadow:0 0 6px rgba(46,204,113,.5)}

    .chatWrap{flex:1;min-height:0;display:flex;flex-direction:column}
    .chatLog{flex:1;min-height:0;padding:12px;background:#0b0b10;font-size:10px;line-height:1.7}
    .chatIn{display:flex;border-top:3px solid #000}
    .chatInput{flex:1;border:none;outline:none;padding:14px;background:#000;color:#fff;font-size:10px;height:50px}

    /* profile modal */
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:999;align-items:center;justify-content:center;padding:18px}
    .modalInner{width:min(520px,92vw);background:#000;border:3px solid #333;box-shadow:8px 8px 0 #000;padding:14px}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;font-size:12px;white-space:pre-wrap}
    .xbtn{background:#555;color:#fff}
    .row{display:flex;gap:10px;flex-wrap:wrap}

    @media(max-width:1000px){
      html,body{overflow:auto}
      .main{flex-direction:column;height:auto;overflow:auto}
      .side{width:100%;min-width:auto}
      .arena{grid-template-columns:1fr 1fr;grid-template-rows:auto auto}
      .center{grid-column:1/-1}
    }
  </style>
</head>

<body>
  <!-- BGM: put bg.mp3 in /public -->
  <audio id="bgm" src="bg.mp3" loop preload="auto"></audio>

  <div class="main">
    <div class="game">
      <div class="topbar">
        <div>
          <h1>DUEL ARENA</h1>
          <div class="pill" style="margin-top:10px">
            <div><b>YOU:</b> <span id="meName">-</span></div>
            <div><b>CREDITS:</b> <span id="meCredits" class="ok">0</span> TC</div>
          </div>
        </div>
        <div class="row">
          <button class="btn gray" onclick="location.reload()">REFRESH</button>
          <button class="btn yellow" onclick="location.href='/support.html'">SUPPORT</button>
          <button id="adminBtn" class="btn green" onclick="location.href='/admin.html'" style="display:none">ADMIN</button>
          <button class="btn gray" onclick="logout()">LOGOUT</button>
        </div>
      </div>

      <div class="tabs" id="tabs">
        <button class="tab active" id="tab-dice" onclick="pickGame('dice')">DICE</button>
        <button class="tab" id="tab-coin" onclick="pickGame('coin')">COIN</button>
        <button class="tab" id="tab-hl" onclick="pickGame('hl')">HI-LO</button>
        <button class="tab" id="tab-roulette" onclick="pickGame('roulette')">ROULETTE</button>
        <button class="tab" id="tab-rps" onclick="pickGame('rps')">R.P.S.</button>
        <button class="tab" id="tab-ttt" onclick="pickGame('ttt')">TIC-TAC-TOE</button>
      </div>

      <div class="arena">
        <!-- P1 -->
        <div class="panel" id="p1Panel">
          <div class="phead">
            <div class="avatarWrap">
              <div class="avatar a1" id="p1Avatar"></div>
              <div class="bubble" id="p1Bubble">ðŸ”¥</div>
            </div>
            <div id="p1Name">EMPTY</div>
          </div>
          <div class="scoreArea">
            <div class="score" id="p1Score">0</div>
            <div class="turnTag" id="p1Turn">YOUR TURN</div>
          </div>
          <div class="pcontrols" id="p1Controls"></div>
        </div>

        <!-- CENTER -->
        <div class="panel center">
          <div class="hdrLine" id="roundLine">ROUND 1</div>
          <div class="statusLine" id="statusLine">WAITING FOR PLAYERS...</div>
          <div class="potLine" id="potLine">POT: <span id="potAmt">0</span> TC</div>
          <div class="proposalLine" id="proposalLine"></div>
          <div class="gameBox" id="gameBox"></div>
        </div>

        <!-- P2 -->
        <div class="panel" id="p2Panel">
          <div class="phead">
            <div class="avatarWrap">
              <div class="avatar a1" id="p2Avatar"></div>
              <div class="bubble" id="p2Bubble">ðŸ”¥</div>
            </div>
            <div id="p2Name">EMPTY</div>
          </div>
          <div class="scoreArea">
            <div class="score" id="p2Score">0</div>
            <div class="turnTag" id="p2Turn">YOUR TURN</div>
          </div>
          <div class="pcontrols" id="p2Controls"></div>
        </div>
      </div>
    </div>

    <!-- SIDEBAR -->
    <div class="side">
      <!-- spectator betting -->
      <div class="sidePanel betWrap">
        <div class="sideHead">SPECTATOR BETTING</div>
        <div class="betBox" style="flex:1;position:relative">
          <div class="betBody">
            <div style="font-size:10px;color:var(--accent);text-align:center;margin-bottom:10px" id="wallet">WALLET: 0 TC</div>
            <div style="font-size:9px;color:#777;text-align:center">CHOOSE SIDE</div>
            <div class="row" style="margin-top:8px">
              <button class="btn" id="bet1" onclick="selBet(1)" style="flex:1">BET SEAT 1</button>
              <button class="btn" id="bet2" onclick="selBet(2)" style="flex:1">BET SEAT 2</button>
            </div>
            <input id="betAmt" type="number" placeholder="AMOUNT" min="1" style="margin-top:10px">
            <button class="btn green betBtn" id="betGo" onclick="placeBet()">PLACE BET</button>
            <div style="margin-top:10px;font-size:9px;color:#888;text-align:center" id="betStatus">No active bet</div>
          </div>
          <div class="betOverlay" id="betOverlay">WAITING FOR DUEL ACCEPT...</div>
        </div>
      </div>

      <!-- players online -->
      <div class="sidePanel playersWrap">
        <div class="sideHead">PLAYERS ONLINE</div>
        <div class="plist custom-scroll" id="plist"></div>
      </div>

      <!-- chat -->
      <div class="sidePanel chatWrap">
        <div class="sideHead">LIVE CHAT</div>
        <div class="chatLog custom-scroll" id="chatLog"></div>
        <div class="chatIn">
          <input class="chatInput" placeholder="Type here..." onkeypress="chatKey(event)">
        </div>
      </div>
    </div>
  </div>

  <!-- PROFILE MODAL -->
  <div class="modal" id="profileModal">
    <div class="modalInner">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div style="color:var(--accent);font-size:12px">PLAYER PROFILE</div>
        <button class="btn xbtn" onclick="closeProfile()">CLOSE</button>
      </div>
      <div class="mono" id="profileText" style="margin-top:10px"></div>
    </div>
  </div>

  <!-- PROPOSAL MODAL -->
  <div class="modal" id="proposalModal">
    <div class="modalInner">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div style="color:var(--accent);font-size:12px">MATCH PROPOSAL</div>
        <button class="btn xbtn" onclick="closeProposal()">CLOSE</button>
      </div>
      <div class="mono" id="proposalText" style="margin-top:10px"></div>
      <div class="row" style="margin-top:12px">
        <button class="btn green" style="flex:1" onclick="respond(true)">ACCEPT</button>
        <button class="btn" style="flex:1;background:#ff4757" onclick="respond(false)">DECLINE</button>
      </div>
    </div>
  </div>

<script src="/socket.io/socket.io.js"></script>
<script>
  // deterrent only (not real security)
  window.addEventListener('contextmenu', e => e.preventDefault());
  window.addEventListener('keydown', (e) => {
    const k = e.key.toLowerCase();
    if (e.ctrlKey && (k === 'u' || k === 's' || k === 'p')) e.preventDefault();
    if (e.key === 'F12') e.preventDefault();
    if (e.ctrlKey && e.shiftKey && (k === 'i' || k === 'j' || k === 'c')) e.preventDefault();
  }, { capture:true });

  // bgm at 5%
  const bgm = document.getElementById('bgm');
  bgm.volume = 0.05;
  window.addEventListener('pointerdown', () => bgm.play().catch(()=>{}), { once:true });

  const socket = io();

  let ME = null;
  let STATE = null;

  const UI = {
    meName: el('meName'),
    meCredits: el('meCredits'),
    adminBtn: el('adminBtn'),
    wallet: el('wallet'),

    p1Panel: el('p1Panel'),
    p2Panel: el('p2Panel'),
    p1Name: el('p1Name'),
    p2Name: el('p2Name'),
    p1Avatar: el('p1Avatar'),
    p2Avatar: el('p2Avatar'),
    p1Bubble: el('p1Bubble'),
    p2Bubble: el('p2Bubble'),
    p1Turn: el('p1Turn'),
    p2Turn: el('p2Turn'),
    p1Score: el('p1Score'),
    p2Score: el('p2Score'),
    p1Controls: el('p1Controls'),
    p2Controls: el('p2Controls'),

    roundLine: el('roundLine'),
    statusLine: el('statusLine'),
    potLine: el('potLine'),
    potAmt: el('potAmt'),
    proposalLine: el('proposalLine'),

    plist: el('plist'),
    chatLog: el('chatLog'),

    betOverlay: el('betOverlay'),
    bet1: el('bet1'),
    bet2: el('bet2'),
    betAmt: el('betAmt'),
    betGo: el('betGo'),
    betStatus: el('betStatus'),

    gameBox: el('gameBox'),

    profileModal: el('profileModal'),
    profileText: el('profileText'),
    proposalModal: el('proposalModal'),
    proposalText: el('proposalText')
  };

  function el(id){ return document.getElementById(id); }
  function esc(s){ return String(s).replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }

  function avatarClass(a){
    return ({avatar1:'a1',avatar2:'a2',avatar3:'a3',avatar4:'a4',avatar5:'a5',avatar6:'a6'})[a] || 'a1';
  }

  async function api(url, opt){
    const r = await fetch(url, opt);
    const j = await r.json().catch(()=>({}));
    if(!r.ok) throw new Error(j.error || "Request failed");
    return j;
  }

  async function boot(){
    try{
      const me = await api('/api/credits');
      ME = me;
      UI.meName.textContent = me.username;
      UI.meCredits.textContent = me.credits ?? 0;
      UI.wallet.textContent = `WALLET: ${(me.credits ?? 0)} TC`;
      if(me.isAdmin) UI.adminBtn.style.display='inline-block';
      socket.emit('hello', { username: me.username });
    }catch(e){
      location.href='/login.html';
    }
  }

  async function reloadCredits(){
    try{
      const me = await api('/api/credits');
      ME = me;
      UI.meCredits.textContent = me.credits ?? 0;
      UI.wallet.textContent = `WALLET: ${(me.credits ?? 0)} TC`;
      refreshBetAccess();
    }catch{}
  }

  async function logout(){
    await fetch('/api/logout',{method:'POST'});
    location.href='/login.html';
  }

  function mySeat(){
    if(!STATE?.room || !ME) return 0;
    if(STATE.room.seat1 === ME.username) return 1;
    if(STATE.room.seat2 === ME.username) return 2;
    return 0;
  }

  function proposer(){
    return STATE?.room?.proposer || null;
  }

  function roundsLabel(k){
    return ({
      sd1:"1 ROUND (SUDDEN DEATH)",
      bo3:"BEST OF 3 (FIRST TO 2)",
      bo5:"BEST OF 5 (FIRST TO 3)",
      rt3:"RACE TO 3",
      rt5:"RACE TO 5"
    })[k] || k;
  }
  function roundsTarget(k){ return ({ sd1:1, bo3:2, bo5:3, rt3:3, rt5:5 })[k] || 1; }

  // -------- Match client state ----------
  const M = {
    game:'dice',
    roundsKey:'sd1',
    bet:10,
    target:1,
    turn:1,
    p1:0,
    p2:0,
    busy:false,
    over:false,
    temp:{}
  };

  function setStatus(t){ UI.statusLine.textContent = t; }
  function setRoundLine(){ UI.roundLine.textContent = `ROUND ${M.p1 + M.p2 + 1}`; }

  function showProposalSummary(){
    const pr = STATE?.room?.proposal;
    if(!pr){
      UI.proposalLine.style.display='none';
      UI.proposalLine.textContent='';
      return;
    }
    UI.proposalLine.style.display='block';
    UI.proposalLine.textContent =
      `PROPOSAL: ${pr.game.toUpperCase()} | ${roundsLabel(pr.roundsKey)} | BET ${pr.bet} TC EACH | POT ${pr.bet*2} TC`;
  }

  function setPot(){
    const pot = STATE?.room?.pot || 0;
    if(pot>0){
      UI.potLine.style.display='flex';
      UI.potAmt.textContent = pot;
    }else{
      UI.potLine.style.display='none';
    }
  }

  function applyTurnUI(){
    UI.p1Panel.classList.toggle('active1', M.turn===1 && !M.over);
    UI.p2Panel.classList.toggle('active2', M.turn===2 && !M.over);
    UI.p1Turn.classList.toggle('show', M.turn===1 && mySeat()===1 && !M.over);
    UI.p2Turn.classList.toggle('show', M.turn===2 && mySeat()===2 && !M.over);

    // opponent also sees a clear indicator
    // show "OPPONENT TURN" tag for the other side
    if(mySeat()===1){
      UI.p2Turn.textContent = (M.turn===2 && !M.over) ? "OPPONENT TURN" : " ";
      UI.p2Turn.classList.toggle('show', M.turn===2 && !M.over);
      UI.p1Turn.textContent = "YOUR TURN";
    } else if(mySeat()===2){
      UI.p1Turn.textContent = (M.turn===1 && !M.over) ? "OPPONENT TURN" : " ";
      UI.p1Turn.classList.toggle('show', M.turn===1 && !M.over);
      UI.p2Turn.textContent = "YOUR TURN";
    } else {
      // spectators just see turn highlight; no tags needed
      UI.p1Turn.classList.remove('show');
      UI.p2Turn.classList.remove('show');
      UI.p1Turn.textContent="YOUR TURN";
      UI.p2Turn.textContent="YOUR TURN";
    }

    // critical: enable/disable the ACTION button properly
    syncActionButton();
  }

  function canAct(){
    if(!STATE?.room?.settingsLocked) return false;
    if(M.over || M.busy) return false;
    const seat = mySeat();
    if(!seat) return false;
    return seat === M.turn;
  }

  // We store the current action button id (per game)
  let currentActionBtnId = null;
  function syncActionButton(){
    if(!currentActionBtnId) return;
    const btn = document.getElementById(currentActionBtnId);
    if(!btn) return;
    btn.disabled = !canAct();
  }

  function resetMatch(){
    M.p1=0; M.p2=0; M.turn=1; M.over=false; M.busy=false; M.temp={};
    UI.p1Score.textContent = "0";
    UI.p2Score.textContent = "0";
    setRoundLine();
    applyTurnUI();
  }

  function award(seat){
    if(M.over) return;
    if(seat===1) M.p1++; else M.p2++;
    UI.p1Score.textContent = String(M.p1);
    UI.p2Score.textContent = String(M.p2);
    setRoundLine();

    if(M.p1>=M.target){ endGame(1); return; }
    if(M.p2>=M.target){ endGame(2); return; }
  }

  function endGame(winner){
    M.over = true;
    applyTurnUI();
    UI.gameBox.innerHTML = `
      <div class="pixelCard">
        <div style="color:var(--accent);font-size:10px;margin-bottom:10px">MATCH COMPLETE</div>
        <div class="bigNum" style="color:${winner===1?'var(--p1)':'var(--p2)'}">SEAT ${winner} WINS!</div>
        <div style="margin-top:10px;font-size:9px;color:#888">SEATS CLEARING...</div>
      </div>
    `;
    setStatus("WINNER DECLARED!");
    setTimeout(()=>socket.emit('match:ended'), 2000);
  }

  // -------- Seat controls / avatar / propose ----------
  function renderSeatControls(){
    const r = STATE?.room;
    if(!r || !ME) return;

    UI.p1Controls.innerHTML = '';
    UI.p2Controls.innerHTML = '';

    const i1 = r.seat1 === ME.username;
    const i2 = r.seat2 === ME.username;

    if(!r.seat1) UI.p1Controls.innerHTML = `<button class="seatBtn" onclick="takeSeat(1)">TAKE SEAT 1</button>`;
    else if(i1) UI.p1Controls.appendChild(seatedPanel());
    else UI.p1Controls.innerHTML = `<div style="padding:10px;color:#888;font-size:10px;text-align:center">SEATED</div>`;

    if(!r.seat2) UI.p2Controls.innerHTML = `<button class="seatBtn" onclick="takeSeat(2)">TAKE SEAT 2</button>`;
    else if(i2) UI.p2Controls.appendChild(seatedPanel());
    else UI.p2Controls.innerHTML = `<div style="padding:10px;color:#888;font-size:10px;text-align:center">SEATED</div>`;
  }

  function seatedPanel(){
    const r = STATE.room;
    const isMeProposer = proposer() === ME.username;
    const locked = !!r.settingsLocked;
    const both = !!(r.seat1 && r.seat2);

    const wrap = document.createElement('div');

    const g0 = document.createElement('div');
    g0.className='group';
    g0.innerHTML = `<div class="gt">SEAT ACTIONS</div>`;
    const leave = document.createElement('button');
    leave.className='btn';
    leave.textContent='LEAVE SEAT';
    leave.onclick = ()=>socket.emit('leaveSeat');
    g0.appendChild(leave);
    wrap.appendChild(g0);

    const g1 = document.createElement('div');
    g1.className='group';
    g1.innerHTML = `<div class="gt">CUSTOM AVATAR</div>`;
    const sel = document.createElement('select');
    sel.innerHTML = `
      <option value="avatar1">AVATAR 1</option>
      <option value="avatar2">AVATAR 2</option>
      <option value="avatar3">AVATAR 3</option>
      <option value="avatar4">AVATAR 4</option>
      <option value="avatar5">AVATAR 5</option>
      <option value="avatar6">AVATAR 6</option>
    `;
    sel.value = ME.avatar || "avatar1";
    sel.disabled = locked;
    sel.onchange = async ()=>{
      await api('/api/avatar', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ avatar: sel.value })
      });
      await reloadCredits();
      socket.emit('hello', { username: ME.username }); // refresh online avatar
    };
    g1.appendChild(sel);
    wrap.appendChild(g1);

    const g2 = document.createElement('div');
    g2.className='group';
    g2.innerHTML = `<div class="gt">${isMeProposer ? 'YOU PROPOSE MATCH' : 'WAITING PROPOSAL'}</div>`;

    if(isMeProposer){
      const roundSel = document.createElement('select');
      roundSel.innerHTML = `
        <option value="sd1">1 ROUND (SUDDEN DEATH)</option>
        <option value="bo3">BEST OF 3 (FIRST TO 2)</option>
        <option value="bo5">BEST OF 5 (FIRST TO 3)</option>
        <option value="rt3">RACE TO 3</option>
        <option value="rt5">RACE TO 5</option>
      `;
      roundSel.value = M.roundsKey;
      roundSel.disabled = locked || !both;

      const bet = document.createElement('input');
      bet.type='number';
      bet.min='1';
      bet.placeholder='BET AMOUNT';
      bet.value = String(M.bet);
      bet.disabled = locked || !both;

      const go = document.createElement('button');
      go.className='btn yellow';
      go.textContent='PROPOSE';
      go.disabled = locked || !both;
      go.onclick = ()=>{
        M.roundsKey = roundSel.value;
        M.bet = parseInt(bet.value,10) || 1;
        socket.emit('proposal:create', { game:M.game, roundsKey:M.roundsKey, bet:M.bet });
      };

      g2.appendChild(roundSel);
      g2.appendChild(bet);
      g2.appendChild(go);
    } else {
      const t = document.createElement('div');
      t.style.fontSize='9px';
      t.style.color='#888';
      t.textContent = 'You will receive ACCEPT / DECLINE.';
      g2.appendChild(t);
    }

    wrap.appendChild(g2);

    const g3 = document.createElement('div');
    g3.className='group';
    g3.innerHTML = `<div class="gt">DUEL EMOTES</div>`;
    const row = document.createElement('div');
    row.className='row';
    ["ðŸ˜ˆ","ðŸ˜‚","ðŸ”¥","ðŸ’€","ðŸ˜¤","ðŸ˜Ž"].forEach(e=>{
      const b = document.createElement('button');
      b.className='btn';
      b.textContent=e;
      b.disabled = !STATE.room.settingsLocked; // only after match started
      b.onclick = ()=>socket.emit('duel:emote', { emote:e });
      row.appendChild(b);
    });
    g3.appendChild(row);
    wrap.appendChild(g3);

    return wrap;
  }

  function takeSeat(seat){ socket.emit('takeSeat', { seat }); }

  // -------- Game selection ----------
  function pickGame(g){
    if(!STATE?.room || !ME) return;
    if(STATE.room.settingsLocked) return;
    if(proposer() !== ME.username) return;
    setGame(g);
  }

  function lockTabs(){
    const locked = !!STATE?.room?.settingsLocked;
    const isMeProposer = proposer() === ME?.username;
    document.querySelectorAll('.tab').forEach(t=>{
      t.classList.toggle('locked', locked || !isMeProposer);
    });
  }

  function setGame(g){
    M.game = g;
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    const tab = document.getElementById(`tab-${g}`);
    if(tab) tab.classList.add('active');
    if(STATE?.room?.settingsLocked) renderGame();
  }

  // -------- Games (pixel + proper animations + correct turn enabling) ----------
  function renderGame(){
    currentActionBtnId = null;
    UI.gameBox.innerHTML = '';

    if(M.game === 'hl') renderHL();
    else if(M.game === 'dice') renderDice();
    else if(M.game === 'coin') renderCoin();
    else if(M.game === 'roulette') renderRoulette();
    else if(M.game === 'rps') renderRPS();
    else renderPlaceholder();

    applyTurnUI(); // critical
  }

  function renderPlaceholder(){
    UI.gameBox.innerHTML = `<div class="pixelCard"><div style="color:var(--accent);font-size:10px;margin-bottom:10px">${esc(M.game.toUpperCase())}</div><div style="font-size:9px;color:#888">PIXEL MODE</div></div>`;
  }

  function setActionBtn(btnId){
    currentActionBtnId = btnId;
    syncActionButton();
  }

  // HI-LO (matches your screenshot)
  function renderHL(){
    UI.gameBox.innerHTML = `
      <div class="pixelCard" style="width:min(420px,90%)">
        <div id="cardBox" class="pixelCard" style="margin:0 auto;width:180px;height:240px;display:grid;place-items:center">
          <div id="cardNum" class="bigNum">?</div>
        </div>
        <div style="height:12px"></div>
        <button class="btn" id="btnDraw">DRAW</button>
      </div>
    `;
    setActionBtn('btnDraw');

    const cardBox = document.getElementById('cardBox');
    const cardNum = document.getElementById('cardNum');

    document.getElementById('btnDraw').onclick = () => {
      if(!canAct()) return;
      M.busy = true; syncActionButton();

      cardBox.classList.remove('animShake'); void cardBox.offsetWidth; cardBox.classList.add('animShake');

      setTimeout(()=>{
        const v = 1 + Math.floor(Math.random()*13);
        cardNum.textContent = String(v);

        if(M.turn===1){
          M.temp.p1 = v;
          setStatus(`SEAT 1 DREW ${v}. SEAT 2 TURN.`);
          M.turn = 2;
        } else {
          const p1 = M.temp.p1 ?? 0;
          setStatus(`SEAT 1: ${p1} vs SEAT 2: ${v}`);
          if(p1>v){ setStatus("SEAT 1 WINS ROUND!"); award(1); }
          else if(v>p1){ setStatus("SEAT 2 WINS ROUND!"); award(2); }
          else setStatus("DRAW! DRAW AGAIN.");
          M.turn = 1;
        }

        M.busy = false;
        applyTurnUI();
      }, 320);
    };
  }

  // DICE
  function renderDice(){
    UI.gameBox.innerHTML = `
      <div class="pixelCard" style="width:min(420px,90%)">
        <div id="diceRow" class="row" style="justify-content:center;margin:10px 0"></div>
        <button class="btn" id="btnRoll">ROLL</button>
      </div>
    `;
    setActionBtn('btnRoll');

    const row = document.getElementById('diceRow');
    const mkDie = (n)=>`<div class="pixelCard" style="width:70px;height:70px;display:grid;place-items:center"><div class="bigNum" style="font-size:28px">${n}</div></div>`;
    const setDice = (a)=>row.innerHTML = a.map(mkDie).join('');

    setDice([1,1,1]);

    document.getElementById('btnRoll').onclick = ()=>{
      if(!canAct()) return;
      M.busy = true; syncActionButton();

      row.classList.remove('animShake'); void row.offsetWidth; row.classList.add('animShake');

      setTimeout(()=>{
        const r = [1+Math.floor(Math.random()*6),1+Math.floor(Math.random()*6),1+Math.floor(Math.random()*6)];
        setDice(r);
        const t = r[0]+r[1]+r[2];

        if(M.turn===1){
          M.temp.p1=t;
          setStatus(`SEAT 1 ROLLED ${t}. SEAT 2 TURN.`);
          M.turn=2;
        } else {
          const p1=M.temp.p1 ?? 0;
          setStatus(`SEAT 1: ${p1} vs SEAT 2: ${t}`);
          if(p1>t){ setStatus("SEAT 1 WINS ROUND!"); award(1); }
          else if(t>p1){ setStatus("SEAT 2 WINS ROUND!"); award(2); }
          else setStatus("DRAW! ROLL AGAIN.");
          M.turn=1;
        }

        M.busy=false;
        applyTurnUI();
      }, 320);
    };
  }

  // COIN
  function renderCoin(){
    UI.gameBox.innerHTML = `
      <div class="pixelCard" style="width:min(420px,90%)">
        <div id="coin" class="pixelCard" style="margin:0 auto;width:140px;height:140px;display:grid;place-items:center;border-radius:999px;background:#feca57">
          <div id="coinTxt" class="bigNum" style="font-size:28px;color:#000">?</div>
        </div>
        <div style="height:12px"></div>
        <button class="btn" id="btnFlip">FLIP</button>
      </div>
    `;
    setActionBtn('btnFlip');

    const coin = document.getElementById('coin');
    const txt = document.getElementById('coinTxt');

    document.getElementById('btnFlip').onclick = ()=>{
      if(!canAct()) return;
      M.busy=true; syncActionButton();

      coin.classList.remove('animFlip'); void coin.offsetWidth; coin.classList.add('animFlip');

      setTimeout(()=>{
        const heads = Math.random()<.5;
        txt.textContent = heads ? "H" : "T";

        if(M.turn===1){
          M.temp.p1 = heads ? 1 : 0;
          setStatus(`SEAT 1 FLIPPED ${heads?'HEADS':'TAILS'}. SEAT 2 TURN.`);
          M.turn=2;
        } else {
          const p1 = M.temp.p1 ?? 0;
          const p2 = heads ? 1 : 0;
          if(p1===p2) setStatus("DRAW! FLIP AGAIN.");
          else if(p2>p1){ setStatus("SEAT 2 WINS ROUND!"); award(2); }
          else { setStatus("SEAT 1 WINS ROUND!"); award(1); }
          M.turn=1;
        }

        M.busy=false;
        applyTurnUI();
      }, 650);
    };
  }

  // ROULETTE (simple pixel spin)
  function renderRoulette(){
    UI.gameBox.innerHTML = `
      <div class="pixelCard" style="width:min(420px,90%)">
        <div id="wheel" class="pixelCard" style="margin:0 auto;width:220px;height:220px;border-radius:999px;background:conic-gradient(#ff4757 0 20%, #111 20% 40%, #2ecc71 40% 60%, #111 60% 80%, #ff4757 80% 100%);display:grid;place-items:center">
          <div id="wheelTxt" style="font-size:12px;color:#fff">SPIN</div>
        </div>
        <div style="height:12px"></div>
        <button class="btn" id="btnSpin">SPIN</button>
      </div>
    `;
    setActionBtn('btnSpin');

    const wheel = document.getElementById('wheel');
    const txt = document.getElementById('wheelTxt');

    document.getElementById('btnSpin').onclick = ()=>{
      if(!canAct()) return;
      M.busy=true; syncActionButton();

      wheel.classList.remove('animFlip'); void wheel.offsetWidth; wheel.classList.add('animFlip');

      setTimeout(()=>{
        const r = Math.random();
        const out = r < 0.48 ? "BLACK" : r < 0.96 ? "RED" : "GREEN";
        txt.textContent = out;

        if(M.turn===1){
          M.temp.p1=out;
          setStatus(`SEAT 1 SPUN ${out}. SEAT 2 TURN.`);
          M.turn=2;
        } else {
          const p1=M.temp.p1;
          if(p1===out) setStatus("DRAW! SPIN AGAIN.");
          else if(out==="GREEN"){ setStatus("SEAT 2 WINS ROUND!"); award(2); }
          else if(p1==="GREEN"){ setStatus("SEAT 1 WINS ROUND!"); award(1); }
          else if(p1==="RED" && out==="BLACK"){ setStatus("SEAT 1 WINS ROUND!"); award(1); }
          else { setStatus("SEAT 2 WINS ROUND!"); award(2); }
          M.turn=1;
        }

        M.busy=false;
        applyTurnUI();
      }, 650);
    };
  }

  // RPS
  function renderRPS(){
    UI.gameBox.innerHTML = `
      <div class="pixelCard" style="width:min(520px,90%)">
        <div style="font-size:10px;color:#888;margin-bottom:10px">PICK RPS (TURN-BASED)</div>
        <div class="row" style="justify-content:center">
          <button class="btn" id="rRock">ROCK</button>
          <button class="btn" id="rPaper">PAPER</button>
          <button class="btn" id="rScis">SCISSORS</button>
        </div>
        <div style="height:12px"></div>
        <div style="font-size:10px;color:#bbb" id="rpsMsg">WAITING...</div>
      </div>
    `;

    currentActionBtnId = null; // 3 buttons
    const msg = document.getElementById('rpsMsg');

    const doPick = (pick)=>{
      if(!canAct()) return;
      M.busy=true;

      msg.textContent = `SEAT ${M.turn} PICKED ${pick}`;

      const score = (x)=>x==="ROCK"?0:x==="PAPER"?1:2;
      if(M.turn===1){
        M.temp.p1=pick;
        setStatus(`SEAT 1 PICKED. SEAT 2 TURN.`);
        M.turn=2;
      } else {
        const a = score(M.temp.p1);
        const b = score(pick);
        if(a===b) setStatus("DRAW! PICK AGAIN.");
        else if((a+1)%3===b){ setStatus("SEAT 2 WINS ROUND!"); award(2); }
        else { setStatus("SEAT 1 WINS ROUND!"); award(1); }
        M.turn=1;
      }

      M.busy=false;
      applyTurnUI();
    };

    el('rRock').onclick = ()=>doPick("ROCK");
    el('rPaper').onclick = ()=>doPick("PAPER");
    el('rScis').onclick = ()=>doPick("SCISSORS");

    // disable/enable them via applyTurnUI
    const patch = ()=>{
      const disabled = !canAct();
      el('rRock').disabled = disabled;
      el('rPaper').disabled = disabled;
      el('rScis').disabled = disabled;
    };
    const old = applyTurnUI;
    applyTurnUI = function(){
      old();
      patch();
    };
    patch();
  }

  // -------- Chat ----------
  function addChat(user,text){
    const div = document.createElement('div');
    div.innerHTML = `<span style="color:var(--accent)">${esc(user)}:</span> ${esc(text)}`;
    UI.chatLog.appendChild(div);
    UI.chatLog.scrollTop = UI.chatLog.scrollHeight;
  }
  function chatKey(e){
    if(e.key==='Enter'){
      const v = e.target.value.trim();
      if(!v) return;
      socket.emit('chat', v);
      e.target.value='';
    }
  }

  // -------- Profile Card ----------
  async function openProfile(username){
    try{
      const p = await api('/api/player/' + encodeURIComponent(username));
      UI.profileText.textContent =
        `NAME: ${p.username}\nSTART DATE: ${new Date(p.createdAt).toLocaleString()}\nCREDITS: ${p.credits} TC\nAVATAR: ${p.avatar}`;
      UI.profileModal.style.display='flex';
    }catch(e){ alert(e.message); }
  }
  function closeProfile(){ UI.profileModal.style.display='none'; }

  // -------- Proposal modal ----------
  function closeProposal(){ UI.proposalModal.style.display='none'; }
  function respond(accept){
    closeProposal();
    socket.emit('proposal:respond', { accept: !!accept });
  }

  // show bet only for spectators
  const bet = { side:null, amount:0, locked:false };
  function refreshBetAccess(){
    const seated = mySeat() !== 0;
    if(seated){
      UI.betOverlay.style.display = 'flex';
      UI.betOverlay.textContent = 'SPECTATORS ONLY';
      UI.bet1.disabled = true;
      UI.bet2.disabled = true;
      UI.betAmt.disabled = true;
      UI.betGo.disabled = true;
      return;
    }
    // spectators: overlay depends on duel lock
    if(STATE?.room?.settingsLocked){
      UI.betOverlay.style.display = 'none';
      UI.bet1.disabled = false;
      UI.bet2.disabled = false;
      UI.betAmt.disabled = false;
      UI.betGo.disabled = false;
    } else {
      UI.betOverlay.style.display = 'flex';
      UI.betOverlay.textContent = 'WAITING FOR DUEL ACCEPT...';
      UI.bet1.disabled = true;
      UI.bet2.disabled = true;
      UI.betAmt.disabled = true;
      UI.betGo.disabled = true;
    }
  }

  function selBet(s){
    bet.side = s;
    UI.bet1.style.borderColor = (s===1?'#fff':'#000');
    UI.bet2.style.borderColor = (s===2?'#fff':'#000');
  }
  function placeBet(){
    const amt = parseInt(UI.betAmt.value,10);
    if(!bet.side) return alert("Pick a side");
    if(!Number.isFinite(amt) || amt<=0) return alert("Invalid amount");
    if(amt > (ME?.credits ?? 0)) return alert("Insufficient funds");

    bet.amount = amt;
    bet.locked = true;
    UI.betStatus.textContent = `LOCKED: ${amt} TC on SEAT ${bet.side}`;
    UI.betGo.disabled = true;
    UI.betAmt.disabled = true;
    UI.bet1.disabled = true;
    UI.bet2.disabled = true;
  }

  // -------- Players list ----------
  function renderPlayers(players){
    UI.plist.innerHTML = '';
    players.forEach(p=>{
      const div = document.createElement('div');
      div.className='pitem';
      div.onclick = ()=>openProfile(p.username);

      const left = document.createElement('div');
      left.style.display='flex';
      left.style.gap='10px';
      left.style.alignItems='center';

      const av = document.createElement('div');
      av.className = `avatar ${avatarClass(p.avatar)}`;
      left.appendChild(av);

      const name = document.createElement('div');
      name.textContent = p.username;
      name.style.fontSize='11px';
      left.appendChild(name);

      const tag = document.createElement('div');
      tag.className='ptag';
      if(p.seat===1) tag.textContent='SEAT 1';
      else if(p.seat===2) tag.textContent='SEAT 2';
      else tag.textContent='ONLINE';
      left.appendChild(tag);

      const mic = document.createElement('div');
      mic.className = `mic ${p.speaking?'on':''}`;
      mic.textContent = 'ðŸŽ¤';

      div.appendChild(left);
      div.appendChild(mic);
      UI.plist.appendChild(div);
    });
  }

  // -------- Emote bubbles beside avatar ----------
  function showBubble(seat, emote){
    const b = seat===1 ? UI.p1Bubble : UI.p2Bubble;
    b.textContent = emote;
    b.classList.add('show');
    setTimeout(()=>b.classList.remove('show'), 900);
  }

  // -------- Socket events ----------
  socket.on('state', (s)=>{
    STATE = s;

    UI.p1Name.textContent = s.room.seat1 || 'EMPTY';
    UI.p2Name.textContent = s.room.seat2 || 'EMPTY';

    // avatars for seated
    const p1 = s.players.find(x=>x.username===s.room.seat1);
    const p2 = s.players.find(x=>x.username===s.room.seat2);
    UI.p1Avatar.className = `avatar ${avatarClass(p1?.avatar || 'avatar1')}`;
    UI.p2Avatar.className = `avatar ${avatarClass(p2?.avatar || 'avatar1')}`;

    setPot();
    showProposalSummary();
    lockTabs();
    renderPlayers(s.players);
    renderSeatControls();
    refreshBetAccess();

    // status
    if(!s.room.seat1 && !s.room.seat2) setStatus("WAITING FOR PLAYERS...");
    else if(s.room.seat1 && !s.room.seat2) setStatus("WAITING FOR OPPONENT...");
    else if(!s.room.settingsLocked) setStatus(`${proposer() || 'FIRST'} MUST PROPOSE MATCH...`);

    // If match is locked and game not rendered yet -> render
    if(s.room.settingsLocked){
      renderGame();
    } else {
      UI.gameBox.innerHTML = `<div class="pixelCard"><div style="color:var(--accent);font-size:10px;margin-bottom:10px">WAITING</div><div style="font-size:9px;color:#888">MATCH NOT STARTED</div></div>`;
      currentActionBtnId = null;
    }

    // critical: if seated changed, re-evaluate controls/buttons
    applyTurnUI();
  });

  socket.on('chat', (m)=> addChat(m.user, m.text));

  // âœ… BOTH CAN SEE the proposal modal, but only opponent gets buttons
  socket.on('proposal:incoming', ({ proposal })=>{
    if(!ME) return;
    const opp = (STATE?.room?.seat1===proposal.by) ? STATE?.room?.seat2 : STATE?.room?.seat1;
    const amOpponent = (ME.username === opp);

    UI.proposalText.textContent =
      `FROM: ${proposal.by}\nGAME: ${proposal.game.toUpperCase()}\nROUNDS: ${roundsLabel(proposal.roundsKey)}\nBET: ${proposal.bet} TC EACH\nPOT: ${proposal.bet*2} TC\n\n${amOpponent ? 'ACCEPT OR DECLINE.' : 'WAITING OPPONENT RESPONSE...'}`;

    // show modal for BOTH (as requested)
    UI.proposalModal.style.display='flex';

    // disable buttons if you're not opponent
    const btns = UI.proposalModal.querySelectorAll('button');
    // order: CLOSE, ACCEPT, DECLINE
    if(btns[1]) btns[1].disabled = !amOpponent;
    if(btns[2]) btns[2].disabled = !amOpponent;
  });

  socket.on('proposal:error', (e)=> alert(e?.error || "Proposal failed"));

  socket.on('proposal:result', async (r)=>{
    await reloadCredits();
    if(!r.ok && r.error) alert(r.error);
    if(r.ok && r.accepted===false) setStatus("PROPOSAL DECLINED.");
  });

  socket.on('match:started', async ({ proposal, pot })=>{
    await reloadCredits();

    M.game = proposal.game;
    M.roundsKey = proposal.roundsKey;
    M.bet = proposal.bet;
    M.target = roundsTarget(proposal.roundsKey);

    // reset
    M.p1=0; M.p2=0; M.turn=1; M.over=false; M.busy=false; M.temp={};
    UI.p1Score.textContent="0"; UI.p2Score.textContent="0";
    setRoundLine();

    setStatus(`MATCH STARTED: ${proposal.game.toUpperCase()} | ${roundsLabel(proposal.roundsKey)} | POT ${pot} TC`);
    setGame(M.game);
    renderGame();
    applyTurnUI();
  });

  socket.on('duel:emote', ({ from, emote })=>{
    if(!STATE?.room) return;
    const seat = (STATE.room.seat1===from) ? 1 : (STATE.room.seat2===from) ? 2 : 0;
    if(seat) showBubble(seat, emote);
  });

  socket.on('credits:updated', ({ username, credits })=>{
    if(!ME || ME.username !== username) return;
    ME.credits = credits ?? 0;
    UI.meCredits.textContent = ME.credits ?? 0;
    UI.wallet.textContent = `WALLET: ${(ME.credits ?? 0)} TC`;
  });

  // expose
  window.logout = logout;
  window.chatKey = chatKey;
  window.pickGame = pickGame;
  window.takeSeat = takeSeat;
  window.selBet = selBet;
  window.placeBet = placeBet;
  window.closeProfile = closeProfile;
  window.closeProposal = closeProposal;
  window.respond = respond;

  // start
  boot();
</script>
</body>
</html>
