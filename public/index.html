<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DUEL LIVE</title>

  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Rajdhani:wght@600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <style>
    :root{
      --bg-dark:#121216; --bg-panel:#1e1e24;
      --p1-color:#ff4757; --p2-color:#2e86de;
      --accent:#feca57; --text:#ffffff;
      --grid-line:rgba(255,255,255,0.05);
      --sidebar-width:340px;
      --betting-height:255px;
      --players-height:255px;
    }
    *{box-sizing:border-box}
    body{
      background-color:var(--bg-dark);
      background-image:
        linear-gradient(var(--grid-line) 1px, transparent 1px),
        linear-gradient(90deg, var(--grid-line) 1px, transparent 1px);
      background-size:20px 20px;
      color:var(--text);
      font-family:'Press Start 2P',cursive;
      margin:0;
      height:100vh;
      width:100vw;
      overflow:hidden;
      display:flex;
    }
    .custom-scroll{overflow-y:auto;scrollbar-width:thin;scrollbar-color:transparent transparent;transition:scrollbar-color .3s}
    .custom-scroll:hover{scrollbar-color:#555 transparent}
    .custom-scroll::-webkit-scrollbar{width:6px}
    .custom-scroll::-webkit-scrollbar-track{background:transparent}
    .custom-scroll::-webkit-scrollbar-thumb{background-color:transparent;border-radius:3px}
    .custom-scroll:hover::-webkit-scrollbar-thumb{background-color:#555}

    .main-wrapper{
      display:flex;
      width:100%;
      height:100%;
      padding:20px;
      gap:20px;
      overflow:hidden;
      min-height:0;
    }
    .game-section{
      flex:1 1 auto;
      display:flex;
      flex-direction:column;
      height:100%;
      overflow:hidden;
      min-width:0;
      min-height:0;
    }
    .social-sidebar{
      width:var(--sidebar-width);
      min-width:var(--sidebar-width);
      display:flex;
      flex-direction:column;
      gap:15px;
      height:100%;
      overflow:hidden;
      flex:0 0 var(--sidebar-width);
      min-height:0;
    }
    .top-bar{
      width:100%;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      margin-bottom:15px;
      border-bottom:4px solid #333;
      padding-bottom:15px;
      flex-shrink:0;
      flex-wrap:wrap;
    }
    h1{color:var(--accent);font-size:20px;text-shadow:3px 3px 0 #000;margin:0}
    .settings-group{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
    select{
      background:#000;color:#fff;border:2px solid #555;
      padding:10px;font-family:'Press Start 2P';font-size:10px;cursor:pointer;text-transform:uppercase;
    }
    select:disabled{opacity:.35;cursor:not-allowed}
    select:hover{border-color:var(--accent)}

    .btn{
      background:#2f3640;color:#fff;border:2px solid #000;
      padding:10px 12px;font-size:10px;font-family:'Press Start 2P';
      cursor:pointer;box-shadow:3px 3px 0 #000;
    }
    .btn.yellow{background:var(--accent);color:#000}
    .btn.green{background:#2ecc71;color:#000}
    .btn.red{background:#ff4757;color:#fff}
    .btn.gray{background:#555;color:#fff}
    .btn:disabled{opacity:.35;cursor:not-allowed;filter:grayscale(1)}
    .btn:active{transform:translate(2px,2px);box-shadow:1px 1px 0 #000}

    .pill{
      background:#000;
      border:2px solid #555;
      padding:10px 12px;
      font-size:10px;
      color:#aaa;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      min-width:220px;
    }
    .pill b{color:#fff}
    .pill .me{color:var(--accent)}
    .pill .credits{color:#2ecc71}

    .game-selector{
      display:flex;gap:8px;flex-wrap:wrap;justify-content:center;
      margin-bottom:20px;background:#000;padding:10px;border:2px solid #333;border-radius:8px;
      flex-shrink:0;
    }
    .game-tab{
      background:#333;border:2px solid #555;color:#aaa;padding:10px 15px;
      font-size:10px;font-family:'Press Start 2P';cursor:pointer;transition:all .2s;position:relative;top:0;
    }
    .game-tab:hover{background:#444;color:#fff;top:-2px}
    .game-tab.active{background:var(--accent);color:#000;border-color:#fff;box-shadow:0 0 10px var(--accent);z-index:2}
    .game-tab.locked{opacity:.5;pointer-events:none}

    .arena-container{
      display:grid;
      grid-template-columns:1fr 1.2fr 1fr;
      gap:20px;
      align-items:stretch;
      flex-grow:1;
      min-height:0;
      padding:10px;
      overflow:hidden;
    }
    .player-hud{
      background:var(--bg-panel);
      border:4px solid #000;
      display:flex;
      flex-direction:column;
      position:relative;
      box-shadow:4px 4px 0 #000;
      height:100%;
      z-index:1;
      overflow:hidden;
    }
    .player-header{
      padding:10px;
      text-align:center;
      border-bottom:4px solid #000;
      font-size:12px;
      height:46px;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-shrink:0;
      background:#333;
      color:#fff;
      gap:10px;
    }
    .avatar{
      width:26px;height:26px;
      border:2px solid #000;
      background:#111;
      box-shadow:2px 2px 0 #000;
      image-rendering:pixelated;
      display:grid;place-items:center;
      font-family:'Rajdhani',sans-serif;
      font-weight:900;
      color:#fff;
      font-size:14px;
    }
    .avatar.a1{background:#6c5ce7}
    .avatar.a2{background:#00b894}
    .avatar.a3{background:#e17055}
    .avatar.a4{background:#0984e3}
    .avatar.a5{background:#d63031}
    .avatar.a6{background:#2d3436}

    .p1-hud.active-turn{border-color:var(--p1-color);box-shadow:0 0 20px var(--p1-color);z-index:10;transform:scale(1.01)}
    .p2-hud.active-turn{border-color:var(--p2-color);box-shadow:0 0 20px var(--p2-color);z-index:10;transform:scale(1.01)}

    .score-area{display:flex;flex-direction:column;align-items:center;justify-content:center;flex-grow:1;min-height:0}
    .score-display{font-size:60px;font-family:'Rajdhani',sans-serif;font-weight:700}
    .match-point{font-size:10px;color:var(--accent);margin-top:5px;animation:blink 1s infinite;display:none}
    @keyframes blink{50%{opacity:0}}

    .controls-area{
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      justify-content:center;
      background:rgba(0,0,0,.2);
      flex-shrink:0;
      min-height:180px;
    }
    .group{border:2px solid #333;background:#0b0b0f;padding:10px;display:flex;flex-direction:column;gap:8px}
    .group-title{font-size:9px;color:#aaa}

    .arcade-btn{
      width:100%;
      padding:12px 8px;
      font-family:'Press Start 2P';
      font-size:10px;
      text-transform:uppercase;
      border:2px solid #000;
      cursor:pointer;
      background:#444;
      box-shadow:3px 3px 0 #000;
    }
    .arcade-btn:disabled{opacity:.25;cursor:not-allowed;filter:grayscale(1)}
    .arcade-btn.p1{background:var(--p1-color);color:#fff}
    .arcade-btn.p2{background:var(--p2-color);color:#fff}

    .seat-btn{
      width:100%;
      padding:16px 10px;
      background:#333;
      color:#aaa;
      border:2px dashed #666;
      font-family:'Press Start 2P';
      cursor:pointer;
      font-size:10px;
      text-transform:uppercase;
    }
    .seat-btn:hover{color:#fff;border-color:#fff;background:#444}

    .center-stage{
      background:#000;border:4px solid #333;display:flex;flex-direction:column;position:relative;
      box-shadow:inset 0 0 20px rgba(0,0,0,.8);height:100%;
    }
    .round-tracker{
      background:#222;color:#fff;text-align:center;padding:8px;font-size:12px;border-bottom:2px solid #444;
      letter-spacing:2px;text-shadow:2px 2px 0 #000;flex-shrink:0
    }
    .marquee-status{
      background:#111;border-bottom:2px solid #444;color:#888;text-align:center;
      padding:10px;font-size:10px;letter-spacing:1px;min-height:35px;display:flex;align-items:center;justify-content:center;flex-shrink:0
    }
    .pot-line{
      background:#0f0f0f;border-bottom:2px solid #333;color:var(--accent);
      text-align:center;padding:10px;font-size:10px;letter-spacing:1px;
      min-height:35px;display:none;align-items:center;justify-content:center;flex-shrink:0
    }
    .game-board{
      flex-grow:1;display:flex;align-items:center;justify-content:center;
      padding:20px;position:relative;overflow:hidden;perspective:1000px;min-height:0
    }
    .vs-badge{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:60px;font-weight:900;color:rgba(255,255,255,.03);font-family:'Rajdhani',sans-serif;pointer-events:none;z-index:0}

    .sidebar-panel{background:var(--bg-panel);border:4px solid #000;display:flex;flex-direction:column;min-height:0;overflow:hidden;box-shadow:4px 4px 0 #000;flex-shrink:0}
    .panel-header{
      background:#2f3640;color:#fff;padding:8px 15px;font-size:10px;border-bottom:4px solid #000;
      text-transform:uppercase;font-weight:bold;display:flex;justify-content:space-between;align-items:center;flex-shrink:0
    }
    .betting-panel{padding:15px;border-bottom:4px solid #000;background:#191919}
    .betting-wrapper{position:relative;height:var(--betting-height);flex:0 0 var(--betting-height)}
    .betting-overlay{
      position:absolute;top:0;left:0;width:100%;height:100%;
      background:rgba(0,0,0,.85);z-index:10;
      display:flex;align-items:center;justify-content:center;
      color:#aaa;font-size:10px;text-align:center;padding:20px;line-height:1.5;
    }
    .wallet{text-align:center;color:var(--accent);margin-bottom:10px;font-size:10px}
    .bet-label{font-size:8px;color:#666;margin-bottom:5px;text-align:center;text-transform:uppercase;letter-spacing:1px}
    .bet-controls{display:flex;gap:5px;margin-bottom:10px}
    .bet-btn{flex:1;font-size:8px;padding:12px 5px;border:2px solid #333;background:#222;color:#888;cursor:pointer;font-family:'Press Start 2P';transition:all .1s}
    .bet-btn:hover{border-color:#666;color:#fff}
    .bet-btn.selected{border-color:#fff;color:#000;box-shadow:0 0 10px rgba(255,255,255,.2)}
    .bet-btn.p1.selected{background:var(--p1-color)}
    .bet-btn.p2.selected{background:var(--p2-color)}
    .bet-input{
      width:100%;background:#000;border:2px solid #555;color:#fff;
      padding:14px 10px;font-family:'Press Start 2P';font-size:12px;line-height:1.2;
      text-align:center;margin-bottom:5px;height:48px;
    }
    .place-bet-btn{
      width:100%;background:#2ecc71;color:#000;border:2px solid #000;padding:12px;font-family:'Press Start 2P';
      cursor:pointer;font-size:10px;margin-top:5px
    }
    .place-bet-btn:disabled{background:#555;cursor:not-allowed}

    .player-list-container{height:var(--players-height);flex:0 0 var(--players-height);min-height:0;display:flex;flex-direction:column}
    .player-list{flex-grow:1;padding:0;background:#2f3640;overflow-y:auto;min-height:0}
    .player-item{
      display:flex;align-items:center;justify-content:space-between;
      padding:8px 12px;
      border-bottom:1px solid #222;
      font-size:16px;color:#fff;background:#2f3640;
      font-family:'Rajdhani',sans-serif;font-weight:700;
      gap:10px;
      cursor:pointer;
    }
    .player-item:hover{background:#383f4d}
    .player-name{flex-grow:1;display:flex;gap:10px;align-items:center}
    .seatTag{font-size:11px;color:#aaa;border:1px solid #444;border-radius:999px;padding:1px 8px}
    .voice-icon{color:rgba(255,255,255,.2);font-size:14px;transition:all .1s}
    .voice-icon.speaking{color:#2ecc71;text-shadow:0 0 5px #2ecc71;transform:scale(1.1)}

    .chat-container-box{flex:1 1 auto;min-height:0;display:flex;flex-direction:column}
    .chat-inner{flex-grow:1;display:flex;flex-direction:column;background:#1e1e24;min-height:0;overflow:hidden}
    .chat-log{flex-grow:1;padding:15px;font-size:14px;line-height:1.5;color:#ccc;font-family:'Rajdhani',sans-serif;font-weight:600;overflow-y:auto}
    .chat-msg{margin-bottom:8px;word-wrap:break-word}
    .chat-user{font-weight:800;margin-right:5px}
    .chat-text{color:#eee}
    .chat-input-area{display:flex;border-top:4px solid #000;flex-shrink:0}
    .chat-input{
      flex-grow:1;background:#000;border:none;color:#fff;
      padding:15px;font-family:'Press Start 2P';
      font-size:12px;line-height:1.2;
      outline:none;height:52px;
    }

    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:999;align-items:center;justify-content:center;padding:18px}
    .modalInner{width:min(560px,92vw);background:#000;border:4px solid #333;padding:14px;box-shadow:6px 6px 0 #000}
    .modalText{color:#ddd;font-family:'Rajdhani',sans-serif;font-size:16px;line-height:1.6;margin-top:10px}
    .modalBtns{display:flex;gap:10px;margin-top:14px}

    .emote-pop{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:64px;opacity:0;pointer-events:none;text-shadow:4px 4px 0 #000;transition:opacity .15s, transform .15s}
    .emote-pop.show{opacity:1;transform:translate(-50%,-60%)}

    /* simple animations */
    .pop{animation:pop .18s ease-out}
    @keyframes pop{from{transform:scale(.95)}to{transform:scale(1)}}
    .flip{animation:flip .6s ease-in-out}
    @keyframes flip{0%{transform:rotateY(0)}50%{transform:rotateY(180deg)}100%{transform:rotateY(360deg)}}
    .shake{animation:shake .35s ease-in-out}
    @keyframes shake{
      0%,100%{transform:translateX(0)}
      25%{transform:translateX(-6px)}
      50%{transform:translateX(6px)}
      75%{transform:translateX(-4px)}
    }

    @media (max-width:950px){
      body{overflow:auto;height:auto}
      .main-wrapper{flex-direction:column;overflow:visible}
      .social-sidebar{width:100%;min-width:auto;height:auto}
      .chat-container-box{height:250px;flex-grow:0}
      .arena-container{grid-template-columns:1fr 1fr;grid-template-rows:auto auto}
      .center-stage{grid-column:1/-1;grid-row:1}
    }
  </style>
</head>

<body>
  <!-- BG MUSIC (needs /public/bg.mp3) -->
  <audio id="bgm" src="bg.mp3" loop preload="auto"></audio>

<div class="main-wrapper">
  <div class="game-section">
    <div class="top-bar">
      <div>
        <h1>DUEL LIVE</h1>
        <div class="pill" style="margin-top:10px">
          <div><b class="me">YOU:</b> <span id="meName">-</span></div>
          <div><b class="credits">CREDITS:</b> <span id="meCredits">0</span> TC</div>
        </div>
      </div>

      <div class="settings-group">
        <button class="btn gray" onclick="location.reload()">REFRESH</button>
        <button class="btn yellow" onclick="location.href='/support.html'">SUPPORT</button>
        <button id="adminBtn" class="btn green" onclick="location.href='/admin.html'" style="display:none">ADMIN</button>
        <button class="btn gray" onclick="logout()">LOGOUT</button>
      </div>
    </div>

    <div class="game-selector" id="gameTabs">
      <button class="game-tab active" id="tab-dice" onclick="tabPick('dice')">DICE</button>
      <button class="game-tab" id="tab-coin" onclick="tabPick('coin')">COIN</button>
      <button class="game-tab" id="tab-hl" onclick="tabPick('hl')">HI-LO</button>
      <button class="game-tab" id="tab-roulette" onclick="tabPick('roulette')">ROULETTE</button>
      <button class="game-tab" id="tab-rps" onclick="tabPick('rps')">R.P.S.</button>
      <button class="game-tab" id="tab-ttt" onclick="tabPick('ttt')">TIC-TAC-TOE</button>
    </div>

    <div class="arena-container">
      <div class="player-hud p1-hud" id="p1Panel">
        <div class="player-header">
          <div class="avatar" id="p1Avatar"></div>
          <div id="p1Name">EMPTY</div>
        </div>
        <div class="score-area">
          <div class="score-display" id="p1Score">0</div>
          <div class="match-point" id="p1MatchPoint">MATCH POINT</div>
        </div>
        <div class="controls-area" id="p1Controls"></div>
      </div>

      <div class="center-stage">
        <div class="round-tracker" id="roundTracker">ROUND <span>1</span></div>
        <div class="marquee-status" id="status">WAITING FOR PLAYERS...</div>
        <div class="pot-line" id="potLine">POT: <span id="potAmount">0</span> TC</div>

        <div class="game-board" id="gameVisuals">
          <div class="vs-badge">VS</div>
          <div class="emote-pop" id="emotePop">ðŸ”¥</div>
          <div id="gameBox" style="z-index:10;text-align:center;"></div>
        </div>
      </div>

      <div class="player-hud p2-hud" id="p2Panel">
        <div class="player-header">
          <div class="avatar" id="p2Avatar"></div>
          <div id="p2Name">EMPTY</div>
        </div>
        <div class="score-area">
          <div class="score-display" id="p2Score">0</div>
          <div class="match-point" id="p2MatchPoint">MATCH POINT</div>
        </div>
        <div class="controls-area" id="p2Controls"></div>
      </div>
    </div>
  </div>

  <div class="social-sidebar">
    <div class="sidebar-panel betting-wrapper">
      <div class="panel-header">SPECTATOR BETTING</div>
      <div class="betting-panel">
        <div class="wallet" id="walletDisplay">WALLET: 0 TC</div>
        <div class="bet-label">STEP 1: CHOOSE FIGHTER</div>
        <div class="bet-controls">
          <button class="bet-btn p1" onclick="selectBet(1)" id="betP1Btn">BET P1</button>
          <button class="bet-btn p2" onclick="selectBet(2)" id="betP2Btn">BET P2</button>
        </div>
        <div class="bet-label" style="margin-top:10px;">STEP 2: WAGER</div>
        <input type="number" id="betAmount" class="bet-input" placeholder="AMOUNT" min="1" max="1000000">
        <button class="place-bet-btn" id="placeBetBtn" onclick="placeSpectatorBet()">PLACE BET</button>
        <div id="betStatus" style="font-size:9px;text-align:center;color:#888;margin-top:5px;">No active bet</div>
      </div>
      <div class="betting-overlay" id="betOverlay">WAITING FOR<br>DUEL ACCEPT...</div>
    </div>

    <div class="sidebar-panel player-list-container">
      <div class="panel-header">PLAYERS ONLINE</div>
      <div class="player-list custom-scroll" id="playerList"></div>
    </div>

    <div class="sidebar-panel chat-container-box">
      <div class="panel-header">LIVE CHAT</div>
      <div class="chat-inner">
        <div class="chat-log custom-scroll" id="chatLog"></div>
        <div class="chat-input-area">
          <input type="text" class="chat-input" placeholder="Type here..." onkeypress="handleChat(event)">
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal" id="proposalModal">
  <div class="modalInner">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
      <div style="color:#feca57;font-size:12px">MATCH PROPOSAL</div>
      <button class="btn gray" onclick="closeProposal()">CLOSE</button>
    </div>
    <div class="modalText" id="proposalText"></div>
    <div class="modalBtns">
      <button class="btn green" style="flex:1" onclick="respondProposal(true)">ACCEPT</button>
      <button class="btn red" style="flex:1" onclick="respondProposal(false)">DECLINE</button>
    </div>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
  // deterrent only
  window.addEventListener('contextmenu', e => e.preventDefault());

  // start bgm after first user interaction (browser rule)
  const bgm = document.getElementById('bgm');
  bgm.volume = 0.05;
  let bgmStarted = false;
  window.addEventListener('pointerdown', () => {
    if (bgmStarted) return;
    bgmStarted = true;
    bgm.play().catch(()=>{});
  }, { once:true });

  let ME = null;
  const socket = io();
  let currentState = null;

  const DOM = {
    p1Panel: document.getElementById('p1Panel'),
    p2Panel: document.getElementById('p2Panel'),
    p1Ctrls: document.getElementById('p1Controls'),
    p2Ctrls: document.getElementById('p2Controls'),
    p1Score: document.getElementById('p1Score'),
    p2Score: document.getElementById('p2Score'),
    status: document.getElementById('status'),
    round: document.getElementById('roundTracker'),
    potLine: document.getElementById('potLine'),
    potAmount: document.getElementById('potAmount'),
    betOverlay: document.getElementById('betOverlay'),
    p1Name: document.getElementById('p1Name'),
    p2Name: document.getElementById('p2Name'),
    p1Avatar: document.getElementById('p1Avatar'),
    p2Avatar: document.getElementById('p2Avatar'),
    chatLog: document.getElementById('chatLog'),
    playerList: document.getElementById('playerList'),
    emotePop: document.getElementById('emotePop'),
    gameBox: document.getElementById('gameBox')
  };

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  async function mustAuth(){
    const me = await fetch('/api/credits').then(r=>r.json()).catch(()=>({}));
    if(!me.ok){ location.href='/login.html'; return; }
    ME = me;
    document.getElementById('meName').innerText = me.username;
    document.getElementById('meCredits').innerText = (me.credits ?? 0);
    document.getElementById('walletDisplay').innerText = `WALLET: ${(me.credits ?? 0)} TC`;
    if(me.isAdmin) document.getElementById('adminBtn').style.display='inline-block';
  }

  async function reloadCredits(){
    const me = await fetch('/api/credits').then(r=>r.json()).catch(()=>null);
    if(!me || !me.ok) return;
    ME = me;
    document.getElementById('meCredits').innerText = (me.credits ?? 0);
    document.getElementById('walletDisplay').innerText = `WALLET: ${(me.credits ?? 0)} TC`;
  }

  async function logout(){
    await fetch('/api/logout',{method:'POST'});
    location.href='/login.html';
  }

  function roundsLabel(k){
    return ({
      sd1:"1 ROUND (SUDDEN DEATH)",
      bo3:"BEST OF 3 (FIRST TO 2)",
      bo5:"BEST OF 5 (FIRST TO 3)",
      rt3:"RACE TO 3",
      rt5:"RACE TO 5"
    })[k] || k;
  }
  function roundsTarget(k){
    return ({ sd1:1, bo3:2, bo5:3, rt3:3, rt5:5 })[k] || 1;
  }

  function avatarClass(a){
    const map = { avatar1:'a1', avatar2:'a2', avatar3:'a3', avatar4:'a4', avatar5:'a5', avatar6:'a6' };
    return map[a] || 'a1';
  }
  function setAvatar(el, avatar){
    el.className = 'avatar ' + avatarClass(avatar);
    el.textContent = ' ';
  }

  function updateStatus(msg){ DOM.status.innerText = msg; }

  function mySeat(){
    if (!currentState?.room || !ME) return 0;
    if (currentState.room.seat1 === ME.username) return 1;
    if (currentState.room.seat2 === ME.username) return 2;
    return 0;
  }

  function proposerName(){
    return currentState?.room?.proposer || null;
  }

  // ---------- Match state ----------
  const state = {
    game: 'dice',
    roundsKey: 'sd1',
    proposedBet: 10,
    turnSeat: 1, // âœ… turn is SEAT-based, not player-number-based
    p1Score: 0,
    p2Score: 0,
    targetScore: 1,
    isGameOver: false,
    isBusy: false,
    temp: {}
  };

  function resetMatch(){
    state.p1Score = 0;
    state.p2Score = 0;
    state.turnSeat = 1;
    state.isGameOver = false;
    state.isBusy = false;
    state.temp = {};
    updateUI();
  }

  function updateUI(){
    DOM.p1Score.innerText = state.p1Score;
    DOM.p2Score.innerText = state.p2Score;
    DOM.round.innerHTML = `ROUND <span>${state.p1Score + state.p2Score + 1}</span>`;
    document.getElementById('p1MatchPoint').style.display = (state.p1Score === state.targetScore - 1 && state.targetScore > 1) ? 'block' : 'none';
    document.getElementById('p2MatchPoint').style.display = (state.p2Score === state.targetScore - 1 && state.targetScore > 1) ? 'block' : 'none';
  }

  function updateTurn(seat){
    if(state.isGameOver) return;
    state.turnSeat = seat;
    DOM.p1Panel.classList.toggle('active-turn', seat === 1);
    DOM.p2Panel.classList.toggle('active-turn', seat === 2);
    renderGameControls(); // âœ… opponent can click now (based on mySeat/turnSeat)
  }

  function awardPoint(seat){
    if (state.isGameOver) return;
    if (seat === 1) state.p1Score++; else state.p2Score++;
    updateUI();
    if (state.p1Score >= state.targetScore) endGame(1);
    else if (state.p2Score >= state.targetScore) endGame(2);
  }

  function endGame(winnerSeat){
    state.isGameOver = true;
    DOM.p1Panel.classList.remove('active-turn');
    DOM.p2Panel.classList.remove('active-turn');
    DOM.round.innerHTML = `MATCH OVER`;

    DOM.gameBox.innerHTML = `
      <div class="pop" style="background:#000;padding:18px;border:2px solid #333">
        <div style="color:var(--accent);margin-bottom:10px;font-size:10px">MATCH COMPLETE</div>
        <div style="color:${winnerSeat===1?'var(--p1-color)':'var(--p2-color)'};font-size:28px;font-family:'Rajdhani',sans-serif;font-weight:900">
          SEAT ${winnerSeat} WINS!
        </div>
        <div style="color:#aaa;font-size:10px;margin-top:10px;line-height:1.5">
          Seats will clear automatically...
        </div>
      </div>
    `;
    updateStatus("WINNER DECLARED!");
    setTimeout(()=>socket.emit('match:ended'), 2500);
  }

  // ---------- Socket state ----------
  socket.on('state', (s) => {
    currentState = s;

    DOM.p1Name.innerText = s.room.seat1 ? s.room.seat1 : "EMPTY";
    DOM.p2Name.innerText = s.room.seat2 ? s.room.seat2 : "EMPTY";

    const p1 = s.players.find(p => p.username === s.room.seat1);
    const p2 = s.players.find(p => p.username === s.room.seat2);
    setAvatar(DOM.p1Avatar, p1?.avatar || "avatar1");
    setAvatar(DOM.p2Avatar, p2?.avatar || "avatar1");

    // pot in game area
    if (s.room.pot > 0) {
      DOM.potLine.style.display = 'flex';
      DOM.potAmount.innerText = s.room.pot;
    } else {
      DOM.potLine.style.display = 'none';
    }

    // betting overlay: only open when locked
    DOM.betOverlay.style.display = s.room.settingsLocked ? 'none' : 'flex';

    // game tab lock: only proposer can pick game BEFORE accept
    const isMeProposer = (ME && s.room.proposer === ME.username);
    document.querySelectorAll('.game-tab').forEach(t => {
      t.classList.toggle('locked', !isMeProposer || s.room.settingsLocked);
    });

    renderSeatControls();
    renderPlayers(s.players);

    // status text
    if (!s.room.seat1 && !s.room.seat2) updateStatus("WAITING FOR PLAYERS...");
    else if (s.room.seat1 && !s.room.seat2) updateStatus(`${s.room.proposer || 'FIRST'} MUST WAIT FOR OPPONENT...`);
    else if (!s.room.settingsLocked && s.room.seat1 && s.room.seat2) {
      updateStatus(`${s.room.proposer} MUST PROPOSE MATCH...`);
    }
  });

  socket.on('chat', (m) => addChat(m));

  socket.on('proposal:incoming', ({ to, proposal }) => {
    if (!ME || ME.username !== to) return;
    document.getElementById('proposalText').innerHTML =
      `<b>FROM:</b> ${escapeHtml(proposal.by)}<br>
       <b>GAME:</b> ${escapeHtml(proposal.game.toUpperCase())}<br>
       <b>ROUNDS:</b> ${escapeHtml(roundsLabel(proposal.roundsKey))}<br>
       <b>BET:</b> ${proposal.bet} TC (EACH)<br>
       <b>POT:</b> ${proposal.bet * 2} TC`;
    document.getElementById('proposalModal').style.display='flex';
  });

  socket.on('proposal:error', (e) => alert(e?.error || "Proposal failed"));

  socket.on('proposal:result', async (r) => {
    await reloadCredits();
    if (!r.ok && r.error) alert(r.error);
    if (r.ok && r.accepted === false) updateStatus("PROPOSAL DECLINED.");
  });

  socket.on('match:started', async ({ proposal, pot }) => {
    await reloadCredits();

    state.game = proposal.game;
    state.targetScore = roundsTarget(proposal.roundsKey);
    state.roundsKey = proposal.roundsKey;

    resetMatch();
    setGame(state.game);
    updateStatus(`MATCH STARTED: ${proposal.game.toUpperCase()} | ${roundsLabel(proposal.roundsKey)} | POT ${pot} TC`);
    updateTurn(1);
  });

  socket.on("credits:updated", ({ username, credits }) => {
    if (!ME || ME.username !== username) return;
    ME.credits = credits ?? 0;
    document.getElementById('meCredits').innerText = (ME.credits ?? 0);
    document.getElementById('walletDisplay').innerText = `WALLET: ${(ME.credits ?? 0)} TC`;
  });

  socket.on('duel:emote', ({ from, emote }) => {
    DOM.emotePop.textContent = emote;
    DOM.emotePop.classList.add('show');
    setTimeout(()=>DOM.emotePop.classList.remove('show'), 700);
  });

  // ---------- Player click shows credits ----------
  async function onPlayerClick(p){
    const r = await fetch('/api/player/' + encodeURIComponent(p.username));
    const j = await r.json().catch(()=>({}));
    if(!r.ok){ alert(j.error || "Failed"); return; }
    alert(`PLAYER: ${j.username}\nCREDITS: ${j.credits} TC`);
  }

  function renderPlayers(list){
    DOM.playerList.innerHTML = '';
    list.forEach(p=>{
      const item = document.createElement('div');
      item.className='player-item';
      item.onclick = ()=>onPlayerClick(p);

      const left = document.createElement('div');
      left.className='player-name';

      const av = document.createElement('div');
      av.className = 'avatar ' + avatarClass(p.avatar);
      av.textContent = ' ';
      left.appendChild(av);

      const nm = document.createElement('div');
      nm.textContent = p.username;
      left.appendChild(nm);

      if (p.username === currentState?.room?.proposer) {
        const tag = document.createElement('div');
        tag.className = 'seatTag';
        tag.textContent = `PROPOSER`;
        left.appendChild(tag);
      } else if (p.seat === 1 || p.seat === 2) {
        const tag = document.createElement('div');
        tag.className = 'seatTag';
        tag.textContent = `SEAT ${p.seat}`;
        left.appendChild(tag);
      }

      const mic = document.createElement('i');
      mic.className='fas fa-microphone voice-icon' + (p.speaking ? ' speaking' : '');

      item.appendChild(left);
      item.appendChild(mic);
      DOM.playerList.appendChild(item);
    });
  }

  // ---------- Chat ----------
  function addChat({user,text}){
    const div = document.createElement('div');
    div.className='chat-msg';
    div.innerHTML = `<span class="chat-user" style="color:#feca57">${escapeHtml(user)}:</span> <span class="chat-text">${escapeHtml(text)}</span>`;
    DOM.chatLog.appendChild(div);
    DOM.chatLog.scrollTop = DOM.chatLog.scrollHeight;
  }

  function handleChat(e){
    if(e.key==='Enter'){
      const txt = e.target.value;
      if(!txt.trim()) return;
      socket.emit('chat', txt.trim());
      e.target.value='';
    }
  }

  // ---------- Proposal modal ----------
  function closeProposal(){ document.getElementById('proposalModal').style.display='none'; }
  function respondProposal(accept){
    closeProposal();
    socket.emit('proposal:respond', { accept: !!accept });
  }

  // ---------- Seats / Avatar / Emotes ----------
  function takeSeat(seat){ socket.emit('takeSeat', { seat }); }
  function leaveSeat(){ socket.emit('leaveSeat'); }

  async function setMyAvatar(avatar){
    const r = await fetch('/api/avatar', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ avatar })
    });
    const j = await r.json().catch(()=>({}));
    if(!r.ok){ alert(j.error || 'Failed'); return; }
    await reloadCredits();
    socket.emit('hello', { username: ME.username });
  }

  function sendEmote(emote){ socket.emit('duel:emote', { emote }); }

  function renderSeatControls(){
    const s = currentState?.room;
    if (!s || !ME) return;

    const iAmSeat1 = s.seat1 === ME.username;
    const iAmSeat2 = s.seat2 === ME.username;
    const iAmSeated = iAmSeat1 || iAmSeat2;
    const locked = !!s.settingsLocked;

    DOM.p1Ctrls.innerHTML = '';
    DOM.p2Ctrls.innerHTML = '';

    if (!s.seat1) DOM.p1Ctrls.innerHTML = `<button class="seat-btn" onclick="takeSeat(1)">TAKE SEAT 1</button>`;
    else if (iAmSeat1) DOM.p1Ctrls.appendChild(seatedPanel(locked));
    else DOM.p1Ctrls.innerHTML = `<div style="color:#aaa;font-size:10px;text-align:center;padding:10px">SEATED</div>`;

    if (!s.seat2) DOM.p2Ctrls.innerHTML = `<button class="seat-btn" onclick="takeSeat(2)">TAKE SEAT 2</button>`;
    else if (iAmSeat2) DOM.p2Ctrls.appendChild(seatedPanel(locked));
    else DOM.p2Ctrls.innerHTML = `<div style="color:#aaa;font-size:10px;text-align:center;padding:10px">SEATED</div>`;

    renderGameControls();
  }

  function seatedPanel(locked){
    const wrap = document.createElement('div');

    const g0 = document.createElement('div');
    g0.className = 'group';
    g0.innerHTML = `<div class="group-title">SEAT ACTIONS</div>`;
    const leaveBtn = document.createElement('button');
    leaveBtn.className = 'arcade-btn';
    leaveBtn.textContent = 'LEAVE SEAT';
    leaveBtn.onclick = ()=>leaveSeat();
    g0.appendChild(leaveBtn);
    wrap.appendChild(g0);

    const g1 = document.createElement('div');
    g1.className = 'group';
    g1.innerHTML = `<div class="group-title">AVATAR</div>`;
    const sel = document.createElement('select');
    sel.innerHTML = `
      <option value="avatar1">AVATAR 1</option>
      <option value="avatar2">AVATAR 2</option>
      <option value="avatar3">AVATAR 3</option>
      <option value="avatar4">AVATAR 4</option>
      <option value="avatar5">AVATAR 5</option>
      <option value="avatar6">AVATAR 6</option>
    `;
    sel.value = ME.avatar || "avatar1";
    sel.onchange = ()=>setMyAvatar(sel.value);
    g1.appendChild(sel);
    wrap.appendChild(g1);

    const gE = document.createElement('div');
    gE.className = 'group';
    gE.innerHTML = `<div class="group-title">DUEL EMOTES</div>`;
    const emWrap = document.createElement('div');
    emWrap.style.display='flex'; emWrap.style.gap='8px'; emWrap.style.flexWrap='wrap';

    const isSeated = mySeat() !== 0;
    const canEmote = isSeated && currentState?.room?.settingsLocked;

    ["ðŸ˜ˆ","ðŸ˜‚","ðŸ”¥","ðŸ’€","ðŸ˜¤","ðŸ˜Ž"].forEach(e=>{
      const b = document.createElement('button');
      b.className = 'arcade-btn';
      b.style.width='auto';
      b.style.padding='10px 10px';
      b.textContent = e;
      b.disabled = !canEmote;
      b.onclick = ()=>sendEmote(e);
      emWrap.appendChild(b);
    });
    gE.appendChild(emWrap);
    wrap.appendChild(gE);

    // proposer controls
    const isMeProposer = proposerName() === ME.username;
    const bothSeated = !!(currentState?.room?.seat1 && currentState?.room?.seat2);

    if (isMeProposer) {
      const g2 = document.createElement('div');
      g2.className = 'group';
      g2.innerHTML = `<div class="group-title">MATCH SETTINGS (YOU PROPOSE)</div>`;

      const roundSel = document.createElement('select');
      roundSel.innerHTML = `
        <option value="sd1">1 ROUND (SUDDEN DEATH)</option>
        <option value="bo3">BEST OF 3 (FIRST TO 2)</option>
        <option value="bo5">BEST OF 5 (FIRST TO 3)</option>
        <option value="rt3">RACE TO 3</option>
        <option value="rt5">RACE TO 5</option>
      `;
      roundSel.value = state.roundsKey || 'sd1';

      const betInput = document.createElement('input');
      betInput.className = 'bet-input';
      betInput.placeholder = "BET AMOUNT";
      betInput.type = "number";
      betInput.min = "1";
      betInput.value = String(state.proposedBet || 10);
      betInput.style.margin = "0";
      betInput.style.height = "48px";

      const proposeBtn = document.createElement('button');
      proposeBtn.className = 'arcade-btn p1';
      proposeBtn.textContent = "PROPOSE MATCH";

      proposeBtn.disabled = locked || !bothSeated;

      proposeBtn.onclick = ()=>{
        state.roundsKey = roundSel.value;
        state.proposedBet = parseInt(betInput.value,10) || 1;
        socket.emit('proposal:create', { game: state.game || 'dice', roundsKey: state.roundsKey, bet: state.proposedBet });
      };

      roundSel.disabled = locked || !bothSeated;
      betInput.disabled = locked || !bothSeated;

      g2.appendChild(roundSel);
      g2.appendChild(betInput);
      g2.appendChild(proposeBtn);
      wrap.appendChild(g2);
    } else {
      const g3 = document.createElement('div');
      g3.className = 'group';
      g3.innerHTML = `<div class="group-title">MATCH SETTINGS</div>
        <div style="font-size:12px;color:#bbb;font-family:Rajdhani,sans-serif;line-height:1.6">
          Waiting for proposer.<br>
          You will receive ACCEPT / DECLINE.
        </div>`;
      wrap.appendChild(g3);
    }

    return wrap;
  }

  // ---------- Game selection ----------
  function tabPick(type){
    const s = currentState?.room;
    if (!s || !ME) return;
    if (s.settingsLocked) return;
    if (s.proposer !== ME.username) return; // âœ… proposer only
    setGame(type);
  }

  // ---------- Games ----------
  function setGame(type){
    state.game = type;

    document.querySelectorAll('.game-tab').forEach(t=>t.classList.remove('active'));
    const tab = document.getElementById(`tab-${type}`);
    if (tab) tab.classList.add('active');

    DOM.gameBox.innerHTML = '';
    if (!currentState?.room?.settingsLocked) {
      updateStatus(`${proposerName() || "FIRST"} MUST PROPOSE MATCH...`);
      return;
    }

    if (type === 'dice') setupDice();
    else if (type === 'coin') setupCoin();
    else if (type === 'hl') setupHiLo();
    else if (type === 'roulette') setupRoulette();
    else if (type === 'rps') setupRPS();
    else setupPlaceholder(type);

    renderGameControls();
  }

  function canPressNow(){
    if (!currentState?.room?.settingsLocked) return false;
    if (state.isGameOver || state.isBusy) return false;
    const seat = mySeat();
    if (!seat) return false;
    return seat === state.turnSeat;
  }

  function renderGameControls(){
    // controls live inside game area; seat panels are for seat/proposal/emotes
    if (!currentState?.room?.settingsLocked) return;

    const seat = mySeat();
    const turn = state.turnSeat;

    // just show a small status button area depending on game
    // game-specific buttons are rendered by game setup, but we keep a safety disable by checking canPressNow() inside handlers
    DOM.p1Panel.classList.toggle('active-turn', turn === 1);
    DOM.p2Panel.classList.toggle('active-turn', turn === 2);

    if (seat === 0) return;
  }

  function setupPlaceholder(type){
    DOM.gameBox.innerHTML = `
      <div class="pop" style="background:#000;padding:16px;border:2px solid #333">
        <div style="color:#feca57;font-size:10px;margin-bottom:10px">${type.toUpperCase()}</div>
        <div style="color:#aaa;font-size:10px;line-height:1.6">(Animation + gameplay placeholder)</div>
      </div>
    `;
  }

  // DICE
  function createDie(v){
    return `<div class="die" v="${v}">
      <div class="dot"></div><div class="dot"></div><div class="dot"></div>
      <div class="dot"></div><div class="dot"></div><div class="dot"></div>
      <div class="dot"></div><div class="dot"></div><div class="dot"></div>
    </div>`;
  }
  function renderDice(el, arr){
    el.innerHTML = arr.map(createDie).join('');
  }
  function r6(){ return Math.ceil(Math.random()*6); }

  function setupDice(){
    DOM.gameBox.innerHTML = `
      <div style="display:flex;flex-direction:column;gap:18px;align-items:center">
        <div id="diceRow" style="display:flex;gap:10px"></div>
        <button class="btn" id="actionBtn">ROLL</button>
        <div style="color:#aaa;font-size:10px;font-family:Rajdhani,sans-serif">Only the player whose turn can roll.</div>
      </div>
    `;
    const row = document.getElementById('diceRow');
    renderDice(row,[1,1,1]);

    document.getElementById('actionBtn').onclick = () => {
      if (!canPressNow()) return;
      state.isBusy = true;
      row.classList.add('shake');

      setTimeout(()=>{
        row.classList.remove('shake');
        const r=[r6(),r6(),r6()];
        renderDice(row,r);
        const t=r.reduce((a,b)=>a+b,0);

        if (state.turnSeat === 1) {
          state.temp.p1 = t;
          updateStatus(`SEAT 1 rolled ${t}. SEAT 2 turn.`);
          state.turnSeat = 2;
        } else {
          const p1 = state.temp.p1 ?? 0;
          updateStatus(`SEAT 1: ${p1} vs SEAT 2: ${t}`);
          if (p1 > t) { updateStatus("SEAT 1 WINS ROUND!"); awardPoint(1); }
          else if (t > p1) { updateStatus("SEAT 2 WINS ROUND!"); awardPoint(2); }
          else updateStatus("DRAW! ROLL AGAIN.");
          state.turnSeat = 1;
        }

        state.isBusy = false;
        updateTurn(state.turnSeat);
      }, 420);
    };
  }

  // COIN
  function setupCoin(){
    DOM.gameBox.innerHTML = `
      <div style="display:flex;flex-direction:column;gap:14px;align-items:center">
        <div id="coin" class="flip" style="width:110px;height:110px;border-radius:999px;border:4px solid #000;background:#feca57;display:grid;place-items:center;font-family:Rajdhani,sans-serif;font-size:28px;font-weight:900;box-shadow:4px 4px 0 #000">?</div>
        <button class="btn" id="coinBtn">FLIP</button>
        <div style="color:#aaa;font-size:10px;font-family:Rajdhani,sans-serif">Turn-based: flip once per turn.</div>
      </div>
    `;
    const coin = document.getElementById('coin');
    const btn = document.getElementById('coinBtn');

    btn.onclick = () => {
      if (!canPressNow()) return;
      state.isBusy = true;

      coin.classList.remove('flip');
      void coin.offsetWidth;
      coin.classList.add('flip');

      setTimeout(()=>{
        const isHeads = Math.random() < 0.5;
        coin.textContent = isHeads ? "H" : "T";
        coin.classList.add('pop');
        setTimeout(()=>coin.classList.remove('pop'), 120);

        if (state.turnSeat === 1) {
          state.temp.p1 = isHeads ? 1 : 0;
          updateStatus(`SEAT 1 flipped ${isHeads ? "HEADS" : "TAILS"}. SEAT 2 turn.`);
          state.turnSeat = 2;
        } else {
          const p1 = state.temp.p1 ?? 0;
          const p2 = isHeads ? 1 : 0;
          if (p1 > p2) awardPoint(1);
          else if (p2 > p1) awardPoint(2);
          else updateStatus("DRAW! FLIP AGAIN.");
          state.turnSeat = 1;
        }

        state.isBusy = false;
        updateTurn(state.turnSeat);
      }, 650);
    };
  }

  // HI-LO
  function setupHiLo(){
    DOM.gameBox.innerHTML = `
      <div style="display:flex;flex-direction:column;gap:12px;align-items:center">
        <div id="card" class="pop" style="width:160px;height:220px;border:4px solid #000;background:#111;box-shadow:6px 6px 0 #000;display:grid;place-items:center;font-family:Rajdhani,sans-serif;font-size:40px;font-weight:900;color:#fff">?</div>
        <button class="btn" id="hlBtn">DRAW</button>
      </div>
    `;
    const card = document.getElementById('card');
    document.getElementById('hlBtn').onclick = () => {
      if (!canPressNow()) return;
      state.isBusy = true;
      const v = 1 + Math.floor(Math.random()*13);
      card.textContent = v;
      card.classList.add('pop');
      setTimeout(()=>card.classList.remove('pop'), 120);

      if (state.turnSeat === 1) {
        state.temp.p1 = v;
        updateStatus(`SEAT 1 drew ${v}. SEAT 2 turn.`);
        state.turnSeat = 2;
      } else {
        const p1 = state.temp.p1 ?? 0;
        if (p1 > v) awardPoint(1);
        else if (v > p1) awardPoint(2);
        else updateStatus("DRAW! DRAW AGAIN.");
        state.turnSeat = 1;
      }
      state.isBusy = false;
      updateTurn(state.turnSeat);
    };
  }

  // RPS
  function setupRPS(){
    DOM.gameBox.innerHTML = `
      <div style="display:flex;flex-direction:column;gap:12px;align-items:center">
        <div id="rpsRow" style="display:flex;gap:12px;flex-wrap:wrap;justify-content:center"></div>
        <div id="rpsPick" style="color:#aaa;font-size:10px;font-family:Rajdhani,sans-serif">Pick: (turn-based)</div>
      </div>
    `;
    const row = document.getElementById('rpsRow');
    const picks = ["ROCK","PAPER","SCISSORS"];
    picks.forEach(p=>{
      const b = document.createElement('button');
      b.className = 'btn';
      b.textContent = p;
      b.onclick = () => {
        if (!canPressNow()) return;
        playRPS(p);
      };
      row.appendChild(b);
    });

    function playRPS(pick){
      state.isBusy = true;
      const v = pick;
      document.getElementById('rpsPick').textContent = `SEAT ${state.turnSeat} picked ${v}`;

      const score = (x) => x==="ROCK"?0:x==="PAPER"?1:2;
      if (state.turnSeat === 1) {
        state.temp.p1 = v;
        state.turnSeat = 2;
        updateStatus(`SEAT 2 TURN: CHOOSE RPS`);
      } else {
        const p1 = state.temp.p1;
        const p2 = v;
        const a = score(p1), b = score(p2);
        if (a===b) updateStatus("DRAW! PICK AGAIN.");
        else if ((a+1)%3===b) awardPoint(2);
        else awardPoint(1);
        state.turnSeat = 1;
      }

      state.isBusy = false;
      updateTurn(state.turnSeat);
    }
  }

  // ROULETTE (simple)
  function setupRoulette(){
    DOM.gameBox.innerHTML = `
      <div style="display:flex;flex-direction:column;gap:12px;align-items:center">
        <div id="wheel" class="pop" style="width:200px;height:200px;border-radius:999px;border:4px solid #000;background:conic-gradient(#ff4757 0 20%, #111 20% 40%, #2ecc71 40% 60%, #111 60% 80%, #ff4757 80% 100%);box-shadow:6px 6px 0 #000;display:grid;place-items:center;font-family:Rajdhani,sans-serif;font-size:18px;font-weight:900;color:#fff">SPIN</div>
        <button class="btn" id="spinBtn">SPIN</button>
      </div>
    `;
    const wheel = document.getElementById('wheel');
    document.getElementById('spinBtn').onclick = ()=>{
      if (!canPressNow()) return;
      state.isBusy = true;

      wheel.classList.remove('flip'); void wheel.offsetWidth; wheel.classList.add('flip');
      setTimeout(()=>{
        const r = Math.random();
        const out = r < 0.48 ? "BLACK" : r < 0.96 ? "RED" : "GREEN";
        wheel.textContent = out;

        if (state.turnSeat === 1) { state.temp.p1 = out; state.turnSeat = 2; updateStatus(`SEAT 1 spun ${out}. SEAT 2 turn.`); }
        else {
          const p1 = state.temp.p1;
          if (p1===out) updateStatus("DRAW! SPIN AGAIN.");
          else if (out==="GREEN") awardPoint(2);
          else if (p1==="GREEN") awardPoint(1);
          else if (p1==="RED" && out==="BLACK") awardPoint(1);
          else awardPoint(2);
          state.turnSeat = 1;
        }

        state.isBusy = false;
        updateTurn(state.turnSeat);
      }, 650);
    };
  }

  // Spectator betting (demo)
  const spec = { betOn:null, betAmount:0, locked:false };
  function selectBet(player){
    if(spec.locked) return;
    spec.betOn = player;
    document.getElementById('betP1Btn').classList.toggle('selected', player===1);
    document.getElementById('betP2Btn').classList.toggle('selected', player===2);
  }
  function placeSpectatorBet(){
    const amt = parseInt(document.getElementById('betAmount').value,10);
    if(!spec.betOn) return alert("Select a Player first!");
    if(!Number.isFinite(amt) || amt<=0) return alert("Invalid amount");
    if(amt > (ME?.credits ?? 0)) return alert("Insufficient funds");

    spec.betAmount = amt;
    spec.locked = true;
    document.getElementById('betStatus').innerText = `LOCKED: ${amt} TC on P${spec.betOn}`;
    document.getElementById('placeBetBtn').disabled = true;
    document.getElementById('betAmount').disabled = true;
    document.getElementById('betP1Btn').disabled = true;
    document.getElementById('betP2Btn').disabled = true;
  }

  // Boot
  (async ()=>{
    await mustAuth();
    socket.emit('hello', { username: ME.username });
    updateStatus("WAITING FOR PLAYERS...");
    setGame(state.game);
    updateTurn(1);
  })();
</script>
</body>
</html>
