<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CASINO DUEL ARENA - LIVE</title>

  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Rajdhani:wght@600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <style>
    :root{
      --bg-dark:#121216; --bg-panel:#1e1e24;
      --p1-color:#ff4757; --p2-color:#2e86de;
      --accent:#feca57; --text:#ffffff;
      --grid-line:rgba(255,255,255,0.05);
      --sidebar-width:340px;

      /* CHANGES: make chat taller by shrinking players panel a bit */
      --betting-height:265px;
      --players-height:265px; /* was 320px */
    }

    *{box-sizing:border-box}
    body{
      background-color:var(--bg-dark);
      background-image:
        linear-gradient(var(--grid-line) 1px, transparent 1px),
        linear-gradient(90deg, var(--grid-line) 1px, transparent 1px);
      background-size:20px 20px;
      color:var(--text);
      font-family:'Press Start 2P',cursive;
      margin:0; padding:0;
      height:100vh; width:100vw;
      overflow:hidden;
      display:flex;
    }

    /* hover scrollbars */
    .custom-scroll{overflow-y:auto;scrollbar-width:thin;scrollbar-color:transparent transparent;transition:scrollbar-color .3s}
    .custom-scroll:hover{scrollbar-color:#555 transparent}
    .custom-scroll::-webkit-scrollbar{width:6px}
    .custom-scroll::-webkit-scrollbar-track{background:transparent}
    .custom-scroll::-webkit-scrollbar-thumb{background-color:transparent;border-radius:3px}
    .custom-scroll:hover::-webkit-scrollbar-thumb{background-color:#555}

    .main-wrapper{
      display:flex; width:100%; height:100%;
      padding:20px; gap:20px;
      overflow:hidden; min-height:0;
    }
    .game-section{
      flex:1 1 auto;
      display:flex; flex-direction:column;
      height:100%; overflow:hidden; min-width:0; min-height:0;
    }
    .social-sidebar{
      width:var(--sidebar-width);
      min-width:var(--sidebar-width);
      display:flex; flex-direction:column;
      gap:15px; height:100%;
      overflow:hidden; flex:0 0 var(--sidebar-width); min-height:0;
    }

    .top-bar{
      width:100%; display:flex; justify-content:space-between; align-items:center;
      margin-bottom:15px; border-bottom:4px solid #333; padding-bottom:15px;
      flex-shrink:0;
    }
    h1{color:var(--accent);font-size:20px;text-shadow:3px 3px 0 #000;margin:0}

    .settings-group{display:flex;gap:10px;align-items:center}
    select{
      background:#000;color:#fff;border:2px solid #555;
      padding:10px;font-family:'Press Start 2P';font-size:10px;cursor:pointer;text-transform:uppercase;
    }
    select:hover{border-color:var(--accent)}
    .reset-btn{
      background:#ff4757;color:#fff;border:2px solid #000;
      padding:10px 15px;font-size:10px;font-family:'Press Start 2P';
      cursor:pointer;box-shadow:3px 3px 0 #000;
    }
    .reset-btn:active{transform:translate(2px,2px);box-shadow:1px 1px 0 #000}
    .target-display{background:#333;color:#aaa;padding:10px;font-size:10px;border:2px solid #555}

    .game-selector{
      display:flex;gap:8px;flex-wrap:wrap;justify-content:center;
      margin-bottom:20px;background:#000;padding:10px;border:2px solid #333;border-radius:8px;
      flex-shrink:0;
    }
    .game-tab{
      background:#333;border:2px solid #555;color:#aaa;padding:10px 15px;
      font-size:10px;font-family:'Press Start 2P';cursor:pointer;transition:all .2s;position:relative;top:0;
    }
    .game-tab:hover{background:#444;color:#fff;top:-2px}
    .game-tab.active{background:var(--accent);color:#000;border-color:#fff;box-shadow:0 0 10px var(--accent);z-index:2}
    .game-tab.disabled{opacity:.3;pointer-events:none;filter:grayscale(1)}

    .arena-container{
      display:grid;grid-template-columns:1fr 1.2fr 1fr;gap:25px;align-items:stretch;
      flex-grow:1;min-height:0;padding:10px;overflow:hidden;
    }

    .player-hud{
      background:var(--bg-panel);border:4px solid #000;display:flex;flex-direction:column;position:relative;
      box-shadow:4px 4px 0 #000;transition:all .3s ease;height:100%;z-index:1;
    }
    .player-header{
      padding:10px;text-align:center;border-bottom:4px solid #000;font-size:12px;height:40px;
      display:flex;align-items:center;justify-content:center;flex-shrink:0;background:#333;color:#fff;
    }
    .p1-hud.active-turn{border-color:var(--p1-color);box-shadow:0 0 20px var(--p1-color);z-index:10;transform:scale(1.02)}
    .p1-hud.active-turn .player-header{background:var(--p1-color)}
    .p2-hud.active-turn{border-color:var(--p2-color);box-shadow:0 0 20px var(--p2-color);z-index:10;transform:scale(1.02)}
    .p2-hud.active-turn .player-header{background:var(--p2-color)}

    .score-area{display:flex;flex-direction:column;align-items:center;justify-content:center;flex-grow:1;min-height:0}
    .score-display{font-size:60px;font-family:'Rajdhani',sans-serif;font-weight:700}
    .match-point{font-size:10px;color:var(--accent);margin-top:5px;animation:blink 1s infinite;display:none}
    @keyframes blink{50%{opacity:0}}

    .controls-area{
      padding:15px;display:flex;flex-direction:column;gap:10px;justify-content:center;
      min-height:120px;background:rgba(0,0,0,.2);flex-shrink:0;
    }
    .arcade-btn{position:relative;display:block;width:100%;padding:12px 5px;font-family:'Press Start 2P';font-size:10px;text-transform:uppercase;border:none;cursor:pointer;background:none;margin-bottom:5px}
    .arcade-btn::before{
      content:'';position:absolute;top:0;left:0;width:100%;height:100%;
      border:3px solid #000;box-shadow:inset 2px 2px 0 rgba(255,255,255,.2),4px 4px 0 #000;
      z-index:-1;transition:all .1s;background:#444;
    }
    .p1-btn::before{background:var(--p1-color)}
    .p2-btn::before{background:var(--p2-color)}
    .arcade-btn:active::before{transform:translate(3px,3px);box-shadow:inset 2px 2px 0 rgba(0,0,0,.2),1px 1px 0 #000}
    .arcade-btn:disabled{cursor:not-allowed;filter:grayscale(100%);opacity:.3;pointer-events:none}

    .seat-btn{
      width:100%;padding:20px;background:#333;color:#aaa;border:2px dashed #666;
      font-family:'Press Start 2P';cursor:pointer;font-size:10px;text-transform:uppercase;
      margin-top:auto;margin-bottom:auto;transition:all .2s
    }
    .seat-btn:hover{color:#fff;border-color:#fff;background:#444;transform:scale(1.05)}

    .center-stage{
      background:#000;border:4px solid #333;display:flex;flex-direction:column;position:relative;
      box-shadow:inset 0 0 20px rgba(0,0,0,.8);height:100%;
    }
    .round-tracker{background:#222;color:#fff;text-align:center;padding:8px;font-size:12px;border-bottom:2px solid #444;letter-spacing:2px;text-shadow:2px 2px 0 #000;flex-shrink:0}
    .round-tracker span{color:var(--accent)}
    .marquee-status{
      background:#111;border-bottom:2px solid #444;color:#888;text-align:center;
      padding:10px;font-size:10px;letter-spacing:1px;min-height:35px;display:flex;align-items:center;justify-content:center;flex-shrink:0
    }
    .game-board{flex-grow:1;display:flex;align-items:center;justify-content:center;padding:20px;position:relative;overflow:hidden;perspective:1000px;min-height:0}
    .vs-badge{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:60px;font-weight:900;color:rgba(255,255,255,.03);font-family:'Rajdhani',sans-serif;pointer-events:none;z-index:0}

    /* sidebar panels */
    .sidebar-panel{
      background:var(--bg-panel);border:4px solid #000;display:flex;flex-direction:column;min-height:0;overflow:hidden;
      box-shadow:4px 4px 0 #000;flex-shrink:0;
    }
    .panel-header{
      background:#2f3640;color:#fff;padding:8px 15px;font-size:10px;border-bottom:4px solid #000;
      text-transform:uppercase;font-weight:bold;display:flex;justify-content:space-between;align-items:center;flex-shrink:0
    }

    .betting-panel{padding:15px;border-bottom:4px solid #000;background:#191919}
    .betting-overlay{
      position:absolute;top:0;left:0;width:100%;height:100%;
      background:rgba(0,0,0,.85);z-index:10;
      display:flex;align-items:center;justify-content:center;
      color:#aaa;font-size:10px;text-align:center;padding:20px;line-height:1.5;
    }
    .betting-wrapper{position:relative;height:var(--betting-height);flex:0 0 var(--betting-height)}
    .wallet{text-align:center;color:var(--accent);margin-bottom:10px;font-size:10px}
    .bet-label{font-size:8px;color:#666;margin-bottom:5px;text-align:center;text-transform:uppercase;letter-spacing:1px}
    .bet-controls{display:flex;gap:5px;margin-bottom:10px}
    .bet-btn{flex:1;font-size:8px;padding:12px 5px;border:2px solid #333;background:#222;color:#888;cursor:pointer;font-family:'Press Start 2P';transition:all .1s}
    .bet-btn:hover{border-color:#666;color:#fff}
    .bet-btn.selected{border-color:#fff;color:#000;box-shadow:0 0 10px rgba(255,255,255,.2)}
    .bet-btn.p1-btn.selected{background:var(--p1-color)}
    .bet-btn.p2-btn.selected{background:var(--p2-color)}

    /* placeholder cut FIX: line-height + padding */
    .bet-input{
      width:100%;background:#000;border:2px solid #555;color:#fff;
      padding:14px 10px;font-family:'Press Start 2P';font-size:12px;line-height:1.2;
      text-align:center;margin-bottom:5px;height:48px;
    }
    .place-bet-btn{width:100%;background:#2ecc71;color:#000;border:2px solid #000;padding:12px;font-family:'Press Start 2P';cursor:pointer;font-size:10px;margin-top:5px}
    .place-bet-btn:disabled{background:#555;cursor:not-allowed}

    /* players */
    .player-list-container{height:var(--players-height);flex:0 0 var(--players-height);min-height:0;display:flex;flex-direction:column}
    .player-list{flex-grow:1;padding:0;background:#2f3640;overflow-y:auto;min-height:0}

    /* CHANGES: reduce spacing */
    .player-item{
      display:flex;align-items:center;justify-content:space-between;
      padding:8px 12px; /* was 12px 15px */
      border-bottom:1px solid #222;
      font-size:16px;color:#fff;background:#2f3640;
      font-family:'Rajdhani',sans-serif;font-weight:700;
    }
    .player-item:hover{background:#383f4d}
    .player-name{flex-grow:1}
    .voice-icon{color:rgba(255,255,255,.2);font-size:14px;transition:all .1s}
    .voice-icon.speaking{color:#2ecc71;text-shadow:0 0 5px #2ecc71;transform:scale(1.1)}
    .mic-controls{padding:10px;background:#222;border-top:2px solid #000;display:flex;align-items:center;justify-content:space-between;font-size:9px;color:#aaa;flex-shrink:0}
    .mic-btn{background:none;border:2px solid #555;color:#aaa;padding:6px 10px;cursor:pointer;font-family:'Press Start 2P';font-size:8px}
    .mic-btn.active{border-color:#2ecc71;color:#2ecc71}
    .mic-btn:hover{border-color:#fff;color:#fff}

    /* chat */
    .chat-container-box{flex:1 1 auto;min-height:0;display:flex;flex-direction:column}
    .chat-inner{flex-grow:1;display:flex;flex-direction:column;background:#1e1e24;min-height:0;overflow:hidden}
    .chat-log{flex-grow:1;padding:15px;font-size:14px;line-height:1.5;color:#ccc;font-family:'Rajdhani',sans-serif;font-weight:600;overflow-y:auto}
    .chat-msg{margin-bottom:8px;word-wrap:break-word}
    .chat-user{font-weight:800;margin-right:5px}
    .chat-text{color:#eee}
    .chat-input-area{display:flex;border-top:4px solid #000;flex-shrink:0}
    .chat-input{
      flex-grow:1;background:#000;border:none;color:#fff;
      padding:15px;font-family:'Press Start 2P';
      font-size:12px;line-height:1.2;
      outline:none;height:52px;
    }

    /* visuals (same as your mock) ... keep minimal here */
    .dice-row{display:flex;gap:10px;z-index:1}
    .die{width:70px;height:70px;background:#fff;border:4px solid #000;border-radius:8px;display:grid;grid-template-columns:repeat(3,1fr);padding:5px;box-shadow:4px 4px 0 rgba(0,0,0,.5)}
    .dot{background:#000;width:14px;height:14px;border-radius:50%;margin:auto;visibility:hidden}
    .die[v="1"] .dot:nth-child(5){visibility:visible}
    .die[v="2"] .dot:nth-child(1),.die[v="2"] .dot:nth-child(9){visibility:visible}
    .die[v="3"] .dot:nth-child(1),.die[v="3"] .dot:nth-child(5),.die[v="3"] .dot:nth-child(9){visibility:visible}
    .die[v="4"] .dot:nth-child(1),.die[v="4"] .dot:nth-child(3),.die[v="4"] .dot:nth-child(7),.die[v="4"] .dot:nth-child(9){visibility:visible}
    .die[v="5"] .dot:nth-child(1),.die[v="5"] .dot:nth-child(3),.die[v="5"] .dot:nth-child(5),.die[v="5"] .dot:nth-child(7),.die[v="5"] .dot:nth-child(9){visibility:visible}
    .die[v="6"] .dot:nth-child(1),.die[v="6"] .dot:nth-child(3),.die[v="6"] .dot:nth-child(4),.die[v="6"] .dot:nth-child(6),.die[v="6"] .dot:nth-child(7),.die[v="6"] .dot:nth-child(9){visibility:visible}
    .shaking{animation:shake .5s infinite}
    @keyframes shake{0%{transform:translate(1px,1px) rotate(0deg)}25%{transform:translate(-2px,-2px) rotate(2deg)}50%{transform:translate(2px,0px) rotate(-2deg)}75%{transform:translate(-1px,2px) rotate(1deg)}100%{transform:translate(1px,-2px) rotate(-1deg)}}

    @media (max-width:950px){
      body{overflow:auto;height:auto}
      .main-wrapper{flex-direction:column;overflow:visible}
      .social-sidebar{width:100%;min-width:auto;height:auto}
      .chat-container-box{height:250px;flex-grow:0}
      .arena-container{grid-template-columns:1fr 1fr;grid-template-rows:auto auto}
      .center-stage{grid-column:1/-1;grid-row:1}
      .p1-hud{grid-row:2}.p2-hud{grid-row:2}
    }
  </style>
</head>

<body>
<div class="main-wrapper">
  <div class="game-section">
    <div class="top-bar">
      <h1>CASINO</h1>
      <div class="settings-group">
        <div class="target-display" id="targetDisplay">TARGET: 1</div>
        <select id="roundMode" onchange="resetMatch()">
          <option value="1">1 Round (Sudden Death)</option>
          <option value="2">Best of 3 (First to 2)</option>
          <option value="3">Best of 5 (First to 3)</option>
        </select>
        <button onclick="resetMatch()" class="reset-btn">RESET</button>
        <button onclick="goSupport()" class="reset-btn" style="background:#feca57;color:#000">SUPPORT</button>
        <button id="adminBtn" onclick="goAdmin()" class="reset-btn" style="display:none;background:#2ecc71;color:#000">ADMIN</button>
        <button onclick="logout()" class="reset-btn" style="background:#555">LOGOUT</button>
      </div>
    </div>

    <div class="game-selector">
      <button onclick="setGame('dice')" class="game-tab active" id="tab-dice">DICE</button>
      <button onclick="setGame('coin')" class="game-tab" id="tab-coin">COIN</button>
      <button onclick="setGame('hl')" class="game-tab" id="tab-hl">HI-LO</button>
      <button onclick="setGame('roulette')" class="game-tab" id="tab-roulette">ROULETTE</button>
      <button onclick="setGame('rps')" class="game-tab" id="tab-rps">R.P.S.</button>
      <button onclick="setGame('ttt')" class="game-tab" id="tab-ttt">TIC-TAC-TOE</button>
    </div>

    <div class="arena-container">
      <div class="player-hud p1-hud" id="p1Panel">
        <div class="player-header"><div id="p1Name">EMPTY</div></div>
        <div class="score-area">
          <div class="score-display" id="p1Score">0</div>
          <div class="match-point" id="p1MatchPoint">MATCH POINT</div>
        </div>
        <div class="controls-area" id="p1Controls">
          <button class="seat-btn" onclick="toggleSeat(1)">TAKE SEAT</button>
        </div>
      </div>

      <div class="center-stage">
        <div class="round-tracker" id="roundTracker">ROUND <span>1</span></div>
        <div class="marquee-status" id="status">WAITING FOR PLAYERS...</div>
        <div class="game-board" id="gameVisuals"><div class="vs-badge">VS</div></div>
      </div>

      <div class="player-hud p2-hud" id="p2Panel">
        <div class="player-header"><div id="p2Name">EMPTY</div></div>
        <div class="score-area">
          <div class="score-display" id="p2Score">0</div>
          <div class="match-point" id="p2MatchPoint">MATCH POINT</div>
        </div>
        <div class="controls-area" id="p2Controls">
          <button class="seat-btn" onclick="toggleSeat(2)">TAKE SEAT</button>
        </div>
      </div>
    </div>
  </div>

  <div class="social-sidebar">
    <div class="sidebar-panel betting-wrapper">
      <div class="panel-header">SPECTATOR BETTING</div>
      <div class="betting-panel">
        <div class="wallet" id="walletDisplay">WALLET: 1000 TC</div>
        <div class="bet-label">STEP 1: CHOOSE FIGHTER</div>
        <div class="bet-controls">
          <button class="bet-btn p1-btn" onclick="selectBet(1)" id="betP1Btn">BET P1</button>
          <button class="bet-btn p2-btn" onclick="selectBet(2)" id="betP2Btn">BET P2</button>
        </div>

        <div class="bet-label" style="margin-top:10px;">STEP 2: WAGER</div>
        <input type="number" id="betAmount" class="bet-input" placeholder="AMOUNT" min="10" max="1000000">
        <button class="place-bet-btn" id="placeBetBtn" onclick="placeSpectatorBet()">PLACE BET</button>
        <div id="betStatus" style="font-size:9px;text-align:center;color:#888;margin-top:5px;">No active bet</div>
      </div>
      <div class="betting-overlay" id="betOverlay">WAITING FOR<br>2 PLAYERS...</div>
    </div>

    <div class="sidebar-panel player-list-container">
      <div class="panel-header">
        PLAYERS ONLINE
        <div style="font-size:8px;color:#aaa" id="micStatusText">MIC OFF</div>
      </div>

      <!-- CHANGED: empty list, filled by realtime presence -->
      <div class="player-list custom-scroll" id="playerList"></div>

      <div class="mic-controls">
        <div id="micModeBtn" class="mic-btn" onclick="toggleMicMode()">MODE: PUSH-TO-TALK</div>
        <div id="micActiveBtn" class="mic-btn" onmousedown="startTalk()" onmouseup="stopTalk()">HOLD SPACE</div>
      </div>
    </div>

    <div class="sidebar-panel chat-container-box">
      <div class="panel-header">LIVE CHAT</div>
      <div class="chat-inner">
        <!-- CHANGED: empty log -->
        <div class="chat-log custom-scroll" id="chatLog"></div>
        <div class="chat-input-area">
          <input type="text" class="chat-input" placeholder="Type here..." onkeypress="handleChat(event)">
        </div>
      </div>
    </div>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
  // --- Auth gate ---
  let ME = null;
  async function mustAuth(){
    const me = await fetch('/api/me').then(r=>r.json());
    if(!me.authed) { location.href='/login.html'; return; }
    ME = me;
    if(me.isAdmin) document.getElementById('adminBtn').style.display='inline-block';
  }
  function goAdmin(){ location.href='/admin.html'; }
  function goSupport(){ location.href='/support.html'; }
  async function logout(){ await fetch('/api/logout',{method:'POST'}); location.href='/login.html'; }

  // --- Socket realtime ---
  const socket = io();

  const onlineSpeaking = new Map(); // username -> boolean

  function renderPlayers(list){
    const el = document.getElementById('playerList');
    el.innerHTML = '';
    list.forEach(p=>{
      const item = document.createElement('div');
      item.className='player-item';
      const name = document.createElement('div');
      name.className='player-name';
      name.textContent = p.username;
      const mic = document.createElement('i');
      mic.className='fas fa-microphone voice-icon';
      if(onlineSpeaking.get(p.username)) mic.classList.add('speaking');
      item.appendChild(name);
      item.appendChild(mic);
      el.appendChild(item);
    });
  }

  function addChat({user,text}){
    const log = document.getElementById('chatLog');
    const div = document.createElement('div');
    div.className='chat-msg';
    div.innerHTML = `<span class="chat-user" style="color:#feca57">${escapeHtml(user)}:</span> <span class="chat-text">${escapeHtml(text)}</span>`;
    log.appendChild(div);
    log.scrollTop = log.scrollHeight;
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  socket.on('presence', (list) => {
    // list = [{username}]
    renderPlayers(list);
  });
  socket.on('chat', (m) => addChat(m));
  socket.on('speaking', ({user, speaking}) => {
    onlineSpeaking.set(user, speaking);
    // re-render without losing scroll
    const list = Array.from(document.querySelectorAll('#playerList .player-name')).map(n=>({username:n.textContent}));
    renderPlayers(list);
  });

  // --- Voice: mic lights ONLY when audio detected ---
  const voice = { mode:'ptt', isTalking:false, stream:null, audioContext:null, analyser:null, raf:0, lastSpeaking:false };

  async function initAudio(){
    if(voice.stream) return;
    voice.stream = await navigator.mediaDevices.getUserMedia({ audio:true });
    voice.audioContext = new (window.AudioContext || window.webkitAudioContext)();
    voice.analyser = voice.audioContext.createAnalyser();
    const source = voice.audioContext.createMediaStreamSource(voice.stream);
    source.connect(voice.analyser);
    voice.analyser.fftSize = 512;
  }

  function stopAudio(){
    voice.isTalking = false;
    document.getElementById('micStatusText').innerText = "MIC OFF";
    document.getElementById('micStatusText').style.color = "#aaa";
    if(voice.raf) cancelAnimationFrame(voice.raf);
    if(voice.lastSpeaking){
      voice.lastSpeaking = false;
      socket.emit('speaking', false);
    }
  }

  function visualizeMic(){
    const data = new Uint8Array(voice.analyser.frequencyBinCount);
    const loop = () => {
      if(!voice.isTalking) return;
      voice.analyser.getByteFrequencyData(data);
      let sum = 0;
      for(let i=0;i<data.length;i++) sum += data[i];
      const avg = sum / data.length;

      // threshold: tweak if needed
      const speaking = avg > 18;

      if(speaking !== voice.lastSpeaking){
        voice.lastSpeaking = speaking;
        socket.emit('speaking', speaking);
      }
      voice.raf = requestAnimationFrame(loop);
    };
    loop();
  }

  function toggleMicMode(){
    if(voice.mode === 'ptt'){
      voice.mode='open';
      document.getElementById('micModeBtn').innerText="MODE: OPEN MIC";
      document.getElementById('micActiveBtn').style.display='none';
      startTalk();
    } else {
      voice.mode='ptt';
      document.getElementById('micModeBtn').innerText="MODE: PUSH-TO-TALK";
      document.getElementById('micActiveBtn').style.display='block';
      stopTalk();
    }
  }

  async function startTalk(){
    if(voice.mode !== 'ptt' && voice.mode !== 'open') return;
    await initAudio();
    voice.isTalking = true;
    document.getElementById('micStatusText').innerText = "MIC ACTIVE";
    document.getElementById('micStatusText').style.color = "#2ecc71";
    visualizeMic();
  }

  function stopTalk(){
    if(voice.mode !== 'ptt') return;
    stopAudio();
  }

  document.addEventListener('keydown', (e) => {
    if(e.code==='Space' && voice.mode==='ptt' && document.activeElement.tagName!=='INPUT'){
      document.getElementById('micActiveBtn').classList.add('active');
      startTalk();
    }
  });
  document.addEventListener('keyup', (e) => {
    if(e.code==='Space' && voice.mode==='ptt'){
      document.getElementById('micActiveBtn').classList.remove('active');
      stopTalk();
    }
  });

  // --- Chat send (socket) ---
  function handleChat(e){
    if(e.key==='Enter'){
      const txt = e.target.value;
      if(!txt.trim()) return;
      socket.emit('chat', txt.trim());
      e.target.value='';
    }
  }

  // --- Game state (your logic, with key changes only) ---
  const state = {
    game:null, turn:1, p1Score:0, p2Score:0, targetScore:1,
    tempData:{}, isGameOver:false, isBusy:false, coinRot:0,
    seats:{ p1:false, p2:false }
  };
  const spec = { money:1000, betOn:null, betAmount:0, locked:false };

  const DOM = {
    p1Panel: document.getElementById('p1Panel'), p2Panel: document.getElementById('p2Panel'),
    p1Ctrls: document.getElementById('p1Controls'), p2Ctrls: document.getElementById('p2Controls'),
    p1Score: document.getElementById('p1Score'), p2Score: document.getElementById('p2Score'),
    status: document.getElementById('status'), visuals: document.getElementById('gameVisuals'),
    target: document.getElementById('targetDisplay'), round: document.getElementById('roundTracker'),
    wallet: document.getElementById('walletDisplay'), betStatus: document.getElementById('betStatus'),
    placeBtn: document.getElementById('placeBetBtn'), betInput: document.getElementById('betAmount'),
    betOverlay: document.getElementById('betOverlay'),
    p1Name: document.getElementById('p1Name'), p2Name: document.getElementById('p2Name')
  };

  function updateStatus(msg){ DOM.status.innerText = msg; }

  function toggleSeat(player){
    if(state.isBusy) return;
    if(player===1){
      state.seats.p1=true;
      DOM.p1Name.innerText="PLAYER 1";
      DOM.p1Ctrls.innerHTML='<div style="font-size:10px;color:#666;">WAITING...</div>';
    } else {
      state.seats.p2=true;
      DOM.p2Name.innerText="PLAYER 2";
      DOM.p2Ctrls.innerHTML='<div style="font-size:10px;color:#666;">WAITING...</div>';
    }
    checkReady();
  }

  function clearSeats(){
    state.seats.p1=false; state.seats.p2=false;
    DOM.p1Name.innerText="EMPTY";
    DOM.p2Name.innerText="EMPTY";
    DOM.p1Ctrls.innerHTML='<button class="seat-btn" onclick="toggleSeat(1)">TAKE SEAT</button>';
    DOM.p2Ctrls.innerHTML='<button class="seat-btn" onclick="toggleSeat(2)">TAKE SEAT</button>';
    DOM.betOverlay.style.display="flex";
    updateStatus("WAITING FOR PLAYERS...");
    DOM.round.innerHTML = `ROUND <span>1</span>`;
    DOM.visuals.innerHTML = '<div class="vs-badge">VS</div>';
  }

  function checkReady(){
    if(state.seats.p1 && state.seats.p2){
      DOM.betOverlay.style.display="none";
      resetMatch();
    } else {
      updateStatus("WAITING FOR PLAYERS...");
    }
  }

  function resetMatch(){
    if(!state.seats.p1 || !state.seats.p2) return;
    state.p1Score=0; state.p2Score=0; state.turn=1; state.isGameOver=false; state.isBusy=false; state.tempData={}; state.coinRot=0;
    state.targetScore=parseInt(document.getElementById('roundMode').value,10);
    DOM.target.innerText=`TARGET: ${state.targetScore}`;
    updateUI();
    setGame(state.game || 'dice');
  }

  function updateUI(){
    DOM.p1Score.innerText=state.p1Score;
    DOM.p2Score.innerText=state.p2Score;
    DOM.round.innerHTML=`ROUND <span>${state.p1Score+state.p2Score+1}</span>`;
    document.getElementById('p1MatchPoint').style.display=(state.p1Score===state.targetScore-1)?'block':'none';
    document.getElementById('p2MatchPoint').style.display=(state.p2Score===state.targetScore-1)?'block':'none';
  }

  function setBusy(b){
    state.isBusy=b;
    document.querySelectorAll('.game-tab').forEach(t=>t.classList.toggle('disabled', b));
  }

  function toggleButtons(p, en){
    const c = p===1 ? DOM.p1Ctrls : DOM.p2Ctrls;
    c.querySelectorAll('button').forEach(btn=>btn.disabled = !en);
  }

  function updateTurn(p){
    if(state.isGameOver){ toggleButtons(1,false); toggleButtons(2,false); return; }
    state.turn=p;
    if(p===1){
      DOM.p1Panel.classList.add('active-turn'); DOM.p2Panel.classList.remove('active-turn');
      toggleButtons(1,true); toggleButtons(2,false);
    } else {
      DOM.p1Panel.classList.remove('active-turn'); DOM.p2Panel.classList.add('active-turn');
      toggleButtons(1,false); toggleButtons(2,true);
    }
  }

  function awardPoint(p){
    if(state.isGameOver) return;
    if(p===1) state.p1Score++; else state.p2Score++;
    updateUI();
    setTimeout(checkMatchWin, 300);
  }

  function checkMatchWin(){
    if(state.p1Score>=state.targetScore) endGame(1);
    else if(state.p2Score>=state.targetScore) endGame(2);
  }

  // IMPORTANT CHANGE: remove PLAY AGAIN and auto-clear seats
  function endGame(winner){
    state.isGameOver=true;
    setBusy(false);
    toggleButtons(1,false); toggleButtons(2,false);
    DOM.p1Panel.classList.remove('active-turn'); DOM.p2Panel.classList.remove('active-turn');

    DOM.round.innerHTML="MATCH OVER";
    DOM.visuals.innerHTML = `
      <div style="text-align:center;z-index:10;background:#000;padding:18px;border:2px solid #333">
        <div style="color:var(--accent);margin-bottom:10px;font-size:10px">MATCH COMPLETE</div>
        <div style="color:${winner===1?'var(--p1-color)':'var(--p2-color)'};font-size:28px;font-family:'Rajdhani',sans-serif;font-weight:900">
          PLAYER ${winner} WINS!
        </div>
        <div style="color:#aaa;font-size:10px;margin-top:10px;line-height:1.5">
          Seats will clear automatically...
        </div>
      </div>
    `;
    updateStatus("WINNER DECLARED!");

    // clear seats after short delay
    setTimeout(() => {
      clearSeats();
      // also reset betting UI for next match
      spec.locked=false; spec.betOn=null; spec.betAmount=0;
      DOM.placeBtn.disabled=false;
      DOM.betInput.disabled=false;
      DOM.betInput.value='';
      document.getElementById('betP1Btn').disabled=false;
      document.getElementById('betP2Btn').disabled=false;
      document.getElementById('betP1Btn').classList.remove('selected');
      document.getElementById('betP2Btn').classList.remove('selected');
      DOM.betStatus.innerText="No active bet";
      DOM.betStatus.style.color="#888";
    }, 2500);
  }

  // ---- spectator betting (same behavior as your mock) ----
  function selectBet(player){
    if(spec.locked) return;
    spec.betOn = player;
    document.getElementById('betP1Btn').classList.toggle('selected', player===1);
    document.getElementById('betP2Btn').classList.toggle('selected', player===2);
  }
  function placeSpectatorBet(){
    const amt = parseInt(DOM.betInput.value,10);
    if(!spec.betOn) return alert("Select a Player first!");
    if(!Number.isFinite(amt) || amt<=0) return alert("Invalid amount");
    if(amt>spec.money) return alert("Insufficient funds");
    spec.betAmount=amt; spec.money-=amt; spec.locked=true;
    DOM.wallet.innerText=`WALLET: ${spec.money} TC`;
    DOM.betStatus.innerText=`LOCKED: ${amt} TC on P${spec.betOn}`;
    DOM.betStatus.style.color= spec.betOn===1 ? 'var(--p1-color)' : 'var(--p2-color)';
    DOM.placeBtn.disabled=true;
    DOM.betInput.disabled=true;
    document.getElementById('betP1Btn').disabled=true;
    document.getElementById('betP2Btn').disabled=true;
  }

  // ---- game tabs (keep your implementations; dice included for demo) ----
  function setGame(type){
    if(state.isGameOver || state.isBusy) return;
    if(!state.seats.p1 || !state.seats.p2) return;

    state.game=type; state.tempData={};
    document.querySelectorAll('.game-tab').forEach(t=>t.classList.remove('active'));
    document.getElementById(`tab-${type}`).classList.add('active');
    DOM.visuals.innerHTML='<div class="vs-badge">VS</div>';
    DOM.p1Ctrls.innerHTML=''; DOM.p2Ctrls.innerHTML='';

    if(type==='dice') setupDice();
    // keep your other games here if you want (coin/hl/roulette/rps/ttt)
    updateStatus(`${type.toUpperCase()} STARTED. PLAYER 1'S TURN.`);
    updateTurn(1);
  }

  function createBtn(p, txt, fn){
    const b=document.createElement('button');
    b.className=`arcade-btn p${p}-btn`;
    b.innerText=txt;
    b.onclick=fn;
    if(p===1) DOM.p1Ctrls.appendChild(b); else DOM.p2Ctrls.appendChild(b);
  }

  // DICE (same as your mock)
  function setupDice(){
    createBtn(1,"ROLL",()=>runDice(1));
    createBtn(2,"ROLL",()=>runDice(2));
    DOM.visuals.innerHTML += `
      <div style="display:flex;flex-direction:column;gap:30px;align-items:center;">
        <div id="p1Dice" class="dice-row" style="opacity:0.5"></div>
        <div id="p2Dice" class="dice-row" style="opacity:0.5"></div>
      </div>`;
    renderDice('p1Dice',[1,1,1]);
    renderDice('p2Dice',[1,1,1]);
  }
  function renderDice(id,v){
    const el=document.getElementById(id); el.innerHTML='';
    v.forEach(x=>{
      el.innerHTML += `<div class="die" v="${x}">
        <div class="dot"></div><div class="dot"></div><div class="dot"></div>
        <div class="dot"></div><div class="dot"></div><div class="dot"></div>
        <div class="dot"></div><div class="dot"></div><div class="dot"></div>
      </div>`;
    });
  }
  function r6(){ return Math.ceil(Math.random()*6); }

  function runDice(p){
    setBusy(true); toggleButtons(p,false);
    const r=[r6(),r6(),r6()];
    const t=r.reduce((a,b)=>a+b,0);
    const row=document.getElementById(p===1?'p1Dice':'p2Dice');
    row.childNodes.forEach(d=>d.classList.add('shaking'));

    setTimeout(()=>{
      row.childNodes.forEach(d=>d.classList.remove('shaking'));
      if(p===1){
        state.tempData.p1Roll=t;
        renderDice('p1Dice',r);
        row.style.opacity=1;
        updateStatus(`P1 ROLLED ${t}. P2 TURN.`);
        setBusy(false);
        updateTurn(2);
      } else {
        const p1=state.tempData.p1Roll;
        renderDice('p2Dice',r);
        row.style.opacity=1;
        updateStatus(`P1: ${p1}  VS  P2: ${t}`);
        setTimeout(()=>{
          if(p1>t){ updateStatus(`P1 WINS ROUND!`); awardPoint(1); }
          else if(t>p1){ updateStatus(`P2 WINS ROUND!`); awardPoint(2); }
          else { updateStatus("DRAW! ROLL AGAIN."); }
          setTimeout(()=>{
            document.getElementById('p1Dice').style.opacity=0.5;
            document.getElementById('p2Dice').style.opacity=0.5;
            setBusy(false);
            updateTurn(1);
          }, 1400);
        }, 900);
      }
    }, 600);
  }

  // boot
  (async ()=>{
    await mustAuth();
    socket.emit('hello', { username: ME.username });
    clearSeats();
  })();
</script>
</body>
</html>
