<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SUPPORT</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Rajdhani:wght@600;700&display=swap" rel="stylesheet">
  <style>
    body{margin:0;background:#0f0f12;color:#fff;font-family:'Press Start 2P';padding:18px}
    .wrap{max-width:1050px;margin:0 auto}
    h1{color:#feca57;margin:0 0 14px 0}
    .row{display:flex;gap:12px;flex-wrap:wrap;margin:10px 0}
    .btn{background:#2f3640;color:#fff;border:2px solid #000;padding:10px 12px;font-size:10px;font-family:'Press Start 2P';cursor:pointer;box-shadow:3px 3px 0 #000}
    .card{background:#121218;border:2px solid #333;padding:12px;box-shadow:3px 3px 0 #000}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    input,textarea{width:100%;background:#000;border:2px solid #333;color:#fff;padding:10px;font-family:ui-monospace}
    textarea{min-height:90px}
    table{width:100%;border-collapse:collapse;font-family:'Rajdhani',sans-serif;font-size:14px}
    th,td{border-bottom:1px solid #222;padding:10px;text-align:left;vertical-align:top}
    th{color:#feca57;font-family:'Press Start 2P';font-size:10px}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-size:12px;white-space:pre-wrap}
    .tag{display:inline-block;border:1px solid #444;border-radius:999px;padding:2px 8px;font-size:11px;color:#aaa}
  </style>
</head>
<body>
<div class="wrap">
  <h1>SUPPORT</h1>
  <div class="row">
    <button class="btn" onclick="location.href='/'">BACK</button>
    <button class="btn" onclick="location.reload()">REFRESH</button>
  </div>

  <div class="grid">
    <div class="card">
      <div style="margin-bottom:10px">OPEN NEW TICKET</div>
      <input id="subj" placeholder="SUBJECT" />
      <textarea id="msg" placeholder="Describe your issue..."></textarea>
      <div class="row">
        <button class="btn" onclick="createTicket()">SUBMIT</button>
      </div>
    </div>

    <div class="card">
      <div style="margin-bottom:10px">MY TICKETS</div>
      <div id="list"></div>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <div style="margin-bottom:10px">TICKET THREAD</div>
    <div id="thread" class="mono">Select a ticket to view messages.</div>
    <div style="margin-top:10px">
      <textarea id="reply" placeholder="Type reply..."></textarea>
      <div class="row">
        <button class="btn" onclick="sendReply()">SEND</button>
      </div>
    </div>
  </div>
</div>

<script>
  let selectedId = null;

  async function api(url, opt){
    const r = await fetch(url, opt);
    const j = await r.json().catch(()=>({}));
    if(!r.ok) throw new Error(j.error || 'Request failed');
    return j;
  }

  async function createTicket(){
    const subject = document.getElementById('subj').value.trim();
    const message = document.getElementById('msg').value.trim();
    if(!subject || !message) return alert('Fill subject and message');

    await api('/api/tickets', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ subject, message })
    });

    document.getElementById('subj').value='';
    document.getElementById('msg').value='';
    loadTickets();
  }

  async function loadTickets(){
    const j = await api('/api/tickets');
    const el = document.getElementById('list');

    if(!j.rows.length){
      el.innerHTML = '<div class="mono">No tickets.</div>';
      return;
    }

    const table = document.createElement('table');
    table.innerHTML = `<thead><tr><th>SUBJECT</th><th>STATUS</th><th>OPEN</th></tr></thead>`;
    const tb = document.createElement('tbody');

    j.rows.forEach(t=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="mono">${t.subject}</td>
        <td><span class="tag">${t.status}</span></td>
        <td></td>
      `;
      const b = document.createElement('button');
      b.className='btn';
      b.textContent='OPEN';
      b.onclick = ()=>selectTicket(t._id);
      tr.children[2].appendChild(b);
      tb.appendChild(tr);
    });

    table.appendChild(tb);
    el.innerHTML='';
    el.appendChild(table);
  }

  async function selectTicket(id){
    selectedId = id;
    const j = await api('/api/tickets/' + id);
    const lines = j.ticket.messages.map(m => `[${new Date(m.ts).toLocaleString()}] ${m.from}: ${m.text}`);
    document.getElementById('thread').textContent = lines.join('\n');
  }

  async function sendReply(){
    if(!selectedId) return alert('Select a ticket first');
    const text = document.getElementById('reply').value.trim();
    if(!text) return;

    await api('/api/tickets/' + selectedId + '/messages', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ text })
    });
    document.getElementById('reply').value='';
    selectTicket(selectedId);
    loadTickets();
  }

  (async ()=>{
    try{
      // redirect if not authed
      const me = await fetch('/api/me').then(r=>r.json());
      if(!me.authed) location.href='/login.html';
      await loadTickets();
    }catch(e){
      alert(e.message);
      location.href='/';
    }
  })();
</script>
</body>
</html>
